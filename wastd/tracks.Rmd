---
title: "Turtle nesting effort"
author: "Florian Mayer, Dept Parks & Wildlife WA"
date: "01/03/2017"
output: html_document
---

```{r r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/projects/turtle-scripts/wastd")
# Data management
library(httr)
library(plyr)
library(dplyr)
library(lubridate)
library(tidyjson)
library(tidyr)  

# Visualisation
library(DT)
library(leaflet)
library(ggplot2)

# Spatial analysis
library(rgdal)
library(sp)
library(maptools)
library(vegan)
library(PCNM)
library(adespatial)

# Load sensitive settings as environment variables
if (file.exists("../config/setup.R")) source("../config/setup.R")

# Data URLs
api <- "https://strandings.dpaw.wa.gov.au/api/1/"
pars <- "?taxon=Cheloniidae&limit=10000&format=json"
url_trk <- paste0(api, "turtle-nest-encounters/", pars)
url_tag <- paste0(api, "animal-encounters/", pars)

# Tracks are TurtleNestEncounters
res_trk <- GET(url_trk, add_headers(Authorization = Sys.getenv("WASTD_APITOKEN")))
data_trk <- res_trk %>% content("text", encoding="utf-8") %>% as.tbl_json()
data_trk_json <- attr(data_trk, "JSON")[[1]]$results  # $features

# Tags are AnimalEncounters
res_tag <- GET(url_tag, add_headers(Authorization = Sys.getenv("WASTD_APITOKEN"))) 
data_tag <- res_tag %>% content("text", encoding="utf-8") %>% as.tbl_json()
data_tag_json <- attr(data_tag, "JSON")[[1]]$results  # features

flatten_trk <- function(li){
  out <- c(li$when, li$longitude, li$latitude, li$species, li$nest_age, li$nest_type)
  out
}

flatten_tag <- function(li){
  out <- c(li$when, li$longitude, li$latitude, li$species, li$health, li$activity)
  out
}

# Datetime
utc <- "UTC"
gmt08 <- "Australia/Perth"
ord <- c("YmdHMSz", "adbYHMS")


# Flatten nested JSON to data.table using tidyjson: slow but more expressive
# tracks <- data_trk %>%
#   enter_object("results") %>%
#   gather_array() %>%
#   spread_values(
#     datetime = with_tz(parse_date_time(jstring("when"), orders=c("YmdHMSz"), tz=utc), tzone=gmt08),
#     species = jstring("species"),
#     nest_age = jstring("nest_age"),
#     nest_type = jstring("nest_type")
#   ) %>%
#   enter_object("where") %>% 
#   gather_array() %>% 
#   spread_values(
#     longitude=as.numeric(jnumber("longitude")),
#     latitude=as.numeric(jnumber("latitude"))
#   ) 

# Flatten nested JSON, parse field formats and rename columns
tracks <- data_trk_json %>%
  ldply(flatten_trk) %>% 
  tbl_df() %>%
  transmute(
    datetime=with_tz(parse_date_time(V1, orders=c("YmdHMSz"), tz=utc), tzone=gmt08),
    longitude=as.numeric(V2),
    latitude=as.numeric(V3),
    date=as_date(as_date(V1) - hours(12)),
    species=V4,
    nest_age=V5,
    nest_type=V6
  ) %>%
  filter(
    latitude < -21.44,
    latitude > -21.47,
    longitude > 114.96,
    longitude < 115.03,
    date > dmy("19/11/2016")
  )
save(tracks, file="data/tracks.Rda")
load("data/tracks.Rda")

tags <- data_tag_json %>% 
  ldply(flatten_tag) %>%
  tbl_df() %>%
  transmute(
    datetime=with_tz(parse_date_time(V1, orders=c("YmdHMSz"), tz=utc), tzone=gmt08),
    longitude=as.numeric(V2),
    latitude=as.numeric(V3),
    date=as_date(as_date(V1) - hours(12)),
    species=V4,
    health=V5,
    activity=V6
  ) %>%
  filter(
    latitude < -21.44,
    latitude > -21.47,
    longitude > 114.96,
    longitude < 115.03,
    date > dmy("19/11/2016")
  )
save(tags, file="data/tags.Rda")
load("data/tags.Rda")

# Metadata on data currency
track_data_retrieved_on <- with_tz(parse_date_time(res_trk$headers$date, orders=ord, tz=utc), tzone=gmt08)
no_track_observations <- nrow(tracks)
earliest_track_observation <- with_tz(min(tracks$datetime), tzone=gmt08)
latest_track_observation <- with_tz(max(tracks$datetime), tzone=gmt08)

tag_data_retrieved_on <- with_tz(parse_date_time(res_tag$headers$date, orders=ord, tz=utc), tzone=gmt08)
no_tag_observations <- nrow(tags)
earliest_tag_observation <- with_tz(min(tags$datetime), tzone=gmt08)
latest_tag_observation <- with_tz(max(tags$datetime), tzone=gmt08)

# TODO get nesting success for tags from "NESTING"
emergences <- bind_rows(
  tracks %>% filter(nest_age=="fresh") %>% transmute(date=date, species=species, type=nest_type),
  tags %>% transmute(date=date, species=species, type=activity)
)

# Tally all tracks and tags
tally_data <- emergences %>%
  group_by(date, species, type) %>% tally(sort=F) %>% ungroup()

# Tally all fresh tracks with nest
tally_all <- emergences %>% 
  group_by(date, species) %>% tally(sort=F) %>% ungroup() %>% 
  transmute(date=date, species=species, all=n)

# Tally fresh tracks with nest
tally_nesting <- emergences %>% 
  filter(type=='successful-crawl' | 
           type=="hatched-nest" | 
           type=="returning-to-water"| 
           type=="laying-eggs"| 
           type=="digging-body-pit"| 
           type=="arriving"| 
           type=="filling-in-egg-chamber"| 
           type=="excavating-egg-chamber"
         ) %>%
  group_by(date, species) %>% tally(sort=F) %>% ungroup() %>%
  transmute(date=date, species=species, nesting=n)

# Join successful nesting emergences with all nesting emergences
nesting <- left_join(tally_all, tally_nesting, by=c('date','species')) 
nesting[is.na(nesting)] <- 0
nesting_success <- mutate(nesting, nesting_success=nesting/all)
```

# Data

## Tracks and nests

* Tracks were recorded on Android tablets using digital data capture software ODK Collect
* Forms "TrackCount 0.10" (Nov-Dec 2016), "Track or Treat 0.26" (Feb 2017) and v0.31 (Feb 2017)
* Data warehouse ODK Aggregate at [dpaw-data.appspot.com](https://dpaw-data.appspot.com/)
* Data exported (through GUI) from dpaw-data as JSON and ingested (scripted) into
  [WAStD](https://strandings.dpaw.wa.gov.au/) after each field trip
* **`r no_track_observations` records** retrieved from WAStD API on 
  `r track_data_retrieved_on` GMT+08 when compiling this workbook
* Track observations span **`r earliest_track_observation` - `r latest_track_observation` GMT+08**

## Tagging of nesting turtles

* Nesting turtles recorded on paper data sheets, entered and QA'd in WAMTRAM
* Data exported from WAMTRAM master db (scripted) into CSV and saved to 
  internal data catalogue
* Data ingested (scripted) from CSV into WAStD
* **`r no_tag_observations` records** retrieved from WAStD API on 
  `r tag_data_retrieved_on` GMT+08 when compiling this workbook
* Tag observations span **`r earliest_tag_observation` - `r latest_tag_observation` GMT+08**

## Turtle dates
The column "date" is the reconstructed emergence date. 

For tagged nesting turtles:

* Assume nesting turtles are recorded between sunset and sunrise
* "turtle tagged 18 Dec 2016 22:15" = "emergence_date 18 Dec 2016"
* "turtle tagged 19 Dec 2016 02:13" = "emergence_date 18 Dec 2016"
* Count as nesting success (assuming all encounters are tagging after nesting)

For fresh tracks ("made last night"): 

* Assume tracks are recorded "the morning after" and before noon
* "fresh track recorded 19 Dec 2016 06:23" = "emergence_date 18 Dec 2016"
* Count as nesting success if nest was found.

For old tracks ("older than from last night"): 

* discard observations
* We do not check for nests on old tracks, so nesting success is "unknown" and 
  analysed as "not successful"
* Nests without clear tracks are recorded as "nest"

All dates are calculated as the calendar date (year, month, day) 12 hours before
the obesrvation's datetime. This subtracts one day from the date of all 
observations made between midnight and noon (mornings), and preserves the data of all
observations made between noon and midnight (afternoons).

All subsequent analyses bin the data by this reconstructed emergence date.

## Interactive datatable: Tracks
```{r}
DT::datatable(tracks)
```

## Interactive datatable: Nesting turtles
```{r}
DT::datatable(tags)
```


## Interactive map
Hover-scroll to zoom, click features to inspect. Hold mouse outside map to scroll page.

Be patient when scrolling, your browser is earning its salary right now.
```{r}
track <- makeAwesomeIcon(icon="home", markerColor="green")
tag <- makeAwesomeIcon(icon="tag", markerColor="blue")
leaflet(tracks) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  setView(lng=115.0, lat=-21.45, zoom=12) %>%
  addAwesomeMarkers(~longitude, ~latitude,
                    data=tracks, label=~species,
                    icon=track,
                    popup=~paste(nest_age, species, nest_type, date)) %>%
  addAwesomeMarkers(~longitude, ~latitude, data=tags, label=~species,
                    icon=tag,
                    popup=~paste(health, species, activity, date))
```

# Nesting effort

## Nesting emergences by species
```{r}
ggplot(tally_data, aes(x=date, y=n, colour=type)) +
  geom_point() + facet_wrap("species", ncol=1)
```

**Note** Track and nest counts within the tagging sector (Jetty to Chevron) 
from the night of 20/11/2016 to 21/11/2016 were not recorded
in the ODK Collect app the morning after, as wind and foot traffic during the night
rendered the tracks unreadable. The tracks and nests were recorded on paper data
sheets and will turn up in the tagging database WAMTRAM2.

November 20-22 were windy, and tracks on the south side of the western end were
likely blown over. This will result in false absence of tracks on 20/11/2016-22/11/2016.
Wind conditions after 22/11/2016 are unknown and may also decrease the number of 
detected tracks.

During the field trip in Feb 2017 (exact dates to be confirmed), a cyclone 
prevented track counts on some days and may have blown away many tracks on other 
days, resulting in days without track counts as well as days with falsely low 
track counts.

There may be more periods with artificially low track count.

**TODO** identify periods of artificially low track count from field diary

**TODO** enter surveys into WAStD, annotate with observations on weather, methodology,
any known biases on recorded data.

## Nesting effort
Tagging, missed turtles and tracks / nests are combined.
```{r}
gg_nesting_abundance <- ggplot(nesting_success, aes(x=date)) +
  geom_bar(aes(y=all), stat="identity", color="black", fill="black") +
  geom_bar(aes(y=nesting), stat="identity", color="green", fill="green") +
  ggtitle("Nesting effort at Thevenard Island") +
  labs(x="Date", y="Number of all and successful nesting emergences") +
  facet_wrap("species", ncol=1)
gg_nesting_abundance
ggsave("data/nesting_abundance.pdf", gg_nesting_abundance, width=7, height=7)
```

## Nesting success
```{r}
gg_nesting_success <- ggplot(nesting_success, aes(x=date, y=nesting_success)) +
  ggtitle("Nesting success at Thevenard Is") +
  geom_bar(stat="identity") +
  labs(x="Date", y ="Success rate of nesting emergences") +
  facet_wrap("species", ncol = 1)
gg_nesting_success
ggsave("data/nesting_success.pdf", gg_nesting_success, width=7, height=7)
```


## Modelling the nesting seasons
This section aims to determine beginning, peak, and end of nesting season per 
species at the given location.

**TODO** This section is under construction.

## Spatial and temporal patterns of abundance
Spatial and temporal patterns of species abundance (daily species tallies) (PCNM)

### Species profiles
Observations have to be summarised into spatial (rectangular grid cells) and 
temporal (days) units and pivoted into species profiles.

Here, a rectangular grid (roughly 100 x 100m) enclosing the study area was 
artificially created. The extent and rectangular shape of the grid has no link 
to the actual study site (the beaches of Thevenard Island), and was chosen solely
for convenience. A grid too narrow will introduce false similarity through 
shared absences, while a grid too wide will lose spatial detail.

It is to be decided whether the actual nesting beaches, gridded into equidistant
sections, would be a more appropriate spatial unit.

```{r}
grd = readOGR("thv_grid.geojson", "OGRGeoJSON")
leaflet() %>% addTiles() %>% addPolygons(data=grd, weight=1, color="orange")
```


```{r}
nesting_events <- bind_rows(
  tracks %>% 
    filter(nest_age=="fresh") %>% 
    transmute(latitude=latitude, 
              longitude=longitude, 
              date=date, 
              species=species, 
              type=nest_type),
  tags %>% 
    transmute(latitude=latitude, 
              longitude=longitude, 
              date=date, 
              species=species, 
              type=activity)
  ) %>%
  mutate(
    diffdate=difftime(date, origin)
  )
# Turn data into SpatialPointsDataFrame (R's "Shapefile")
wgs84 = CRS('+proj=longlat +datum=WGS84 +no_defs')
d.sp <- SpatialPoints(coords=dplyr::select(nesting_events, longitude, latitude), proj4string=wgs84)
d.spdf <- SpatialPointsDataFrame(d.sp, data=nesting_events, proj4string=wgs84)

# Join data to grid polygons to have grid polygon id with each event
d.spdf.grd <- spCbind(d.spdf, over(d.spdf, grd))

# Create species profiles for species track abundance per grid cell id and event date
species_profiles <- d.spdf.grd@data %>% 
  filter(!is.na(id)) %>%
  group_by(diffdate, date, id, species) %>% 
  tally(sort=F) %>% 
  ungroup() %>%
  spread(species, n, fill=0) %>% left_join(grd, by="id", copy=T)
colnames(species_profiles) <- make.names(colnames(species_profiles))
DT::datatable(species_profiles)
# Responding vars: species profiles
# Y.in has one row per survey (date x grid cell)
Y.in <- species_profiles %>% 
  dplyr::select(-id, -diffdate, -date, -xmin, -xmax, -ymin, -ymax)

X.coords <- species_profiles %>% dplyr::select(xmin, ymin)

# Xs: coordinates of grid cells with encounters; Xs.id: plus grid cell ID
# Xs and Xs.id have one row per grid cell with encounters
Xs.id <- grd@data %>% 
  filter(id %in% unique(species_profiles$id)) %>% 
  dplyr::select(id, xmin, ymin)
Xs <- Xs.id %>% dplyr::select(-id)

plot(Xs)

Xt <- unique(species_profiles$diffdate) %>% tbl_df()
colnames(Xt) <- "diffdate"
```

### Correlations between variables
```{r}
pairs(Y.in, main="Correlations between species")
```
The nesting emergence abundance between Flatbacks and Greens seem to correlate inversely.
Observations of Hawksbills and turtles with unknown species ID are sparse.

### Skewness in variables

* Histograms of Y and X will show the distribution of variable values.
* Expected: normal or uniform distribution.
* Right-skewed distributions can be log-transformed.
* Left-skewed distributions can be sqrt-transformed.
* Sparse observations should be Hellinger-transformed to reduce false similarity 
between sites through shared absence (which might be undersampling rather than 
true absence).

```{r}
qplot(Y.in$"chelonia.mydas", geom="histogram") 
qplot(Y.in$"natator.depressus", geom="histogram")
```
The two main species look a bit left-skewed and show many absences.

The Hellinger transformation will help reduce false similarity through shared absences.

```{r}

Y.hel <- Y.in %>% decostand("hellinger")
pairs(Y.hel)
qplot(Y.hel$"chelonia.mydas", geom="histogram")
qplot(Y.hel$"natator.depressus", geom="histogram")
```

Remove linear spatial trends, lest they eat up explanatory power.

```{r}
Y <- residuals(rda(Y.hel, X.coords))
pairs(Y)
```


### PCNM
Party time. 
Following [this tutorial](https://sites.ualberta.ca/~ahamann/teaching/renr690/Lab9.pdf).
```{r}
plot(Xs)
Xs.site.pcnm <- PCNM(dist(Xs))
summary(Xs.site.pcnm)
plot(Xs.site.pcnm$spanning, main="Spanning tree of sites")
Xs.site.pcnm.pos <- as.data.frame(Xs.site.pcnm$vectors)[,which(Xs.site.pcnm$Moran_I$Positive == T)]
sites_pcnm <- cbind(Xs.id, scores(Xs.site.pcnm.pos))
surveys_pcnm <- species_profiles %>% dplyr::left_join(sites_pcnm, by="id", copy=T)
Xs.scores <- dplyr::select(surveys_pcnm, starts_with("V"))

Xt.pcnm <- PCNM(dist(Xt))
summary(Xt.pcnm)
plot(Xt.pcnm$spanning, main="Spanning tree of observation dates")
Xt.pcnm.pos <- as.data.frame(Xt.pcnm$vectors)[,which(Xt.pcnm$Moran_I$Positive == T)]
dates_pcnm <- cbind(Xt, scores(Xt.pcnm.pos))
surveys_pcnm_t <- species_profiles %>% dplyr::left_join(dates_pcnm, by="diffdate", copy=T)
Xt.scores <- dplyr::select(surveys_pcnm_t, starts_with("V"))

Xs.sel <- forward.sel(Y, Xs.scores)
Xt.sel <- forward.sel(Y, Xt.scores)
XS <- Xs.scores %>% dplyr::select(Xs.sel$order)
XT <- Xt.scores %>% dplyr::select(Xt.sel$order)

Xs.sel
Xt.sel
Y.vp <- varpart(Y, ~as.matrix(XS), ~as.matrix(XT))
Y.vp
plot(Y.vp)
```

Outcome: 

* Spatial patterns explain a total of `r round(Y.vp$part$fract$Adj.R.squared[1] * 100, 2)`% of the variance.
* Temporal patterns explain a total of `r round(Y.vp$part$fract$Adj.R.squared[2] * 100, 2)`% of the variance.
* Another `r round(Y.vp$part$indfract$Adj.R.squared[2] * 100, 2)`% of the variance is co-explained by both spatial and temporal patterns.
* The remaining variation that is unexplained through spatial or temporal patterns is
  `r round(Y.vp$part$indfract$Adj.R.squared[4] * 100, 2)`%.

## Spatial patterns
```{r}
plot.xs <- function(nr, coords, scores, fs){
  
  fig <- ordisurf(coords, scores[,nr], bubble=3,
                  main=paste("Spatial pattern", fs[nr,2]), 
                  sub=paste("explains", round(as.numeric(fs[nr,3]), digits=3)*100, 
                            "% variance"))
  pdf(paste0("data/spatial_pattern_", nr, ".pdf"), width=6, height=6)
  fig
  dev.off()
  fig
}

lapply(seq_len(nrow(Xs.sel)), 
       plot.xs, 
       dplyr::select(sites_pcnm, xmin, ymin), 
       dplyr::select(sites_pcnm, starts_with("V")), 
       Xs.sel)
```

### Temporal patterns
```{r}
#' Create a scatterplot of PCNM values against dates.
#' 
#' nr: The row number of the forward.sel dataframe
#' dates: a vector of ymd dates
#' scores: a data.frame of PCNM scores
#' fs: an output data.frame of forward.sel
plot.xt <- function(nr, dates, scores, fs){
  fig <- plot(x=ymd(dates), y=scores[,nr], type="p",
              xlab="", ylab=paste("PCNM", fs[nr,2]), 
              main=paste("Temporal pattern", fs[nr,2]), 
              sub=paste("explains", round(as.numeric(fs[nr,3]), digits=3)*100, "% variance"))
  pdf(paste0("data/temporal_pattern_", nr, ".pdf"), width=6, height=6)
  fig
  dev.off()
  fig
}

# Plot all significant temporal PCNM variables.
# lapply(Xt.sel$order, plot.xt, species_profiles$date, XT, Xt.sel)
```

A spot of modelling!
```{r}
XSm <- as.matrix(XS)
XTm <- as.matrix(XT)

Y.rda <- rda(Y ~ XSm + XTm)
fig <- ordiplot(Y.rda, main="Constrained ordination (RDA) all species", type="none")
points(fig, "sites", pch=21, col="red", bg="yellow")
text(fig, "species", col="blue", cex=0.9)
identify(fig, "spec")
```

# Questions

* Are there any hotspots of different species?
* Do certain species (Gn, Fb) favour certain beach aspects? 
  Correct for difficulty of approach (shallow reef is hard to swim over).
* Does the tagging area cover the main nesting area?


The following figure shows nesting effort as total nesting events across space 
(x-axis) and time (y-axis).

The x-axis shows the grid cell ID of the 100x100m grid used to group encounters
into site x species profiles. The axis can be imagined as if the beach around
Thevenard were cut in one place and straightened into one line.

The y-axis shows the observation date as days since the epoch start (1970).

```{r}
dx <- species_profiles %>%
  transmute(
    grid=id,
    nd=natator.depressus,
    cm=chelonia.mydas
  ) %>%
  cbind(
    date=as.numeric(surveys_pcnm$diffdate)
  )

plot(dx)

ordisurf(
  cbind(dx$grid, dx$date), dx$nd, bubble=3,
  main="Spatiotemporal nesting patterns: Natator depressus",
  sub="Total nesting effort",
  xlab="Beach segment ID", ylab="Day since 1970")

ordisurf(
  cbind(dx$grid, dx$date), dx$cm, bubble=3,
  main="Spatiotemporal nesting patterns: Chelonia mydas",
  sub="Total nesting effort",
  xlab="Beach segment ID", ylab="Day since 1970")
```


```{r, echo=FALSE}
setwd("~/projects/turtle-scripts")
```
