---
title: "Turtle tracks"
author: "Florian Mayer, Dept Parks & Wildlife WA"
date: "12/02/2017"
output: html_document
---

```{r r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/projects/turtle-scripts/wastd")
library(httr)
library(plyr)
library(dplyr)
library(lubridate)
library(tidyjson)
library(DT)
library(leaflet)
library(ggplot2)
library(rgdal)
# install.packages("../data/packfor_0.0-8.tar.gz", repos = NULL, type = "source")
library(packfor)

# Load sensitive settings as environment variables
if (file.exists("../config/setup.R")) source("../config/setup.R")

# Data URLs
api <- "https://strandings.dpaw.wa.gov.au/api/1/"
pars <- "?taxon=Cheloniidae&limit=10000&format=json"
url_trk <- paste0(api, "turtle-nest-encounters/", pars)
url_tag <- paste0(api, "animal-encounters/", pars)

# Tracks are TurtleNestEncounters
res_trk <- GET(url_trk, add_headers(Authorization = Sys.getenv("WASTD_APITOKEN")))
data_trk <- res_trk %>% content("text", encoding="utf-8") %>% as.tbl_json()
data_trk_json <- attr(data_trk, "JSON")[[1]]$results

# Tags are AnimalEncounters
res_tag <- GET(url_tag, add_headers(Authorization = Sys.getenv("WASTD_APITOKEN"))) 
data_tag <- res_tag %>% content("text", encoding="utf-8") %>% as.tbl_json()
data_tag_json <- attr(data_tag, "JSON")[[1]]$results

flatten_trk <- function(li){
  datetime <- li$when
  lon <- li$where$longitude
  lat <- li$where$latitude
  species <- li$species
  nest_age <- li$nest_age
  nest_type <- li$nest_type
  out <- c(datetime, lon, lat, species, nest_age, nest_type)
  out
}

flatten_tag <- function(li){
  datetime <- li$when
  lon <- li$where$longitude
  lat <- li$where$latitude
  species <- li$species
  health <- li$health
  activity <- li$activity
  out <- c(datetime, lon, lat, species, health, activity)
  out
}

utc <- "UTC"
gmt08 <- "Australia/Perth"
ord <- c("YmdHMSz", "adbYHMS")


# Very slow, but more expressive way to flatten nested JSON to CSV:
# tracks <- data_trk %>%
#   enter_object("results") %>%
#   gather_array() %>%
#   spread_values(
#     datetime = jstring("when"),
#     species = jstring("species"),
#     nest_age = jstring("nest_age"),
#     nest_type = jstring("nest_type")
#   ) %>%
#   enter_object("where") %>% 
#   gather_array() %>% 
#   spread_values(
#     lon = jnumber("longitude"),
#     lat = jnumber("latitude")
#   ) %>%
#   mutate(
#     datetime=with_tz(parse_date_time(datetime, orders=c("YmdHMSz"), tz=utc), tzone=gmt08),
#     longitude=as.numeric(longitude),
#     latitude=as.numeric(latitude)
#   )

# Vectorisation performs better:
tr <- ldply(data_trk_json, flatten_trk) %>% tbl_df()
colnames(tr) <- c("datetime_raw", "longitude", "latitude", "species", "nest_age", "nest_type")
tracks <- tr %>%
  mutate(
    datetime=with_tz(parse_date_time(datetime_raw, orders=c("YmdHMSz"), tz=utc), tzone=gmt08),
    longitude=as.numeric(longitude),
    latitude=as.numeric(latitude),
    date=as_date(datetime)
  )
# glimpse(tracks)
save(tracks, file="data/tracks.Rda")
load("data/tracks.Rda")

ta <- ldply(data_tag_json, flatten_tag) %>% tbl_df()
colnames(ta) <- c("datetime", "longitude", "latitude", "species", "health", "activity")
tags <- ta %>%
  mutate(
    datetime=with_tz(parse_date_time(datetime, orders=c("YmdHMSz"), tz=utc), tzone=gmt08),
    longitude=as.numeric(longitude),
    latitude=as.numeric(latitude),
    date=as_date(datetime)
  )
# glimpse(tags)
save(tags, file="data/tags.Rda")
load("data/tags.Rda")

# Metadata on data currency
track_data_retrieved_on <- with_tz(parse_date_time(res_trk$headers$date, orders=ord, tz=utc), tzone=gmt08)
no_track_observations <- nrow(res_trk)
earliest_track_observation <- with_tz(min(tracks$datetime), tzone=gmt08)
latest_track_observation <- with_tz(max(tracks$datetime), tzone=gmt08)

tag_data_retrieved_on <- with_tz(parse_date_time(res_tag$headers$date, orders=ord, tz=utc), tzone=gmt08)
no_tag_observations <- nrow(res_tag)
earliest_tag_observation <- with_tz(min(tags$datetime), tzone=gmt08)
latest_tag_observation <- with_tz(max(tags$datetime), tzone=gmt08)

# Tally all tracks
tally_data <- tracks %>%
  group_by(date, species, nest_age) %>% tally(sort=F) %>% ungroup()

# Tally only "fresh" tracks
tally_fresh <- tracks %>% filter(nest_age=="fresh") %>%
  group_by(date, species, nest_type) %>% tally(sort=F) %>% ungroup()

# Tally all fresh tracks with nest
tally_all <- tracks %>% 
  filter(nest_age=='fresh') %>%
  group_by(date, species) %>% tally(sort=F) %>% ungroup()
colnames(tally_all) <- c('date', 'species', 'all')

# Tally fresh tracks with nest
tally_nesting <- tracks %>% 
  filter(nest_age=='fresh', nest_type=='successful-crawl') %>%
  group_by(date, species) %>% tally(sort=F) %>% ungroup()
colnames(tally_nesting) <- c('date', 'species', 'nesting')


# Join successful nesting crawls with all nesting crawls
nesting <- left_join(tally_all, tally_nesting, by=c('date','species')) 
nesting[is.na(nesting)] <- 0
nesting_success <- mutate(nesting, nesting_success=nesting/all)
```

# Data

## Tracks and nests

* Tracks were recorded on Android tablets using digital data capture software ODK Collect
* Forms "TrackCount 0.10" (Nov-Dec 2016), "Track or Treat 0.26" (Feb 2017) and v0.31 (Feb 2017)
* Data warehouse ODK Aggregate at [dpaw-data.appspot.com](https://dpaw-data.appspot.com/)
* Data exported (through GUI) from dpaw-data as JSON and ingested (scripted) into
  [WAStD](https://strandings.dpaw.wa.gov.au/) after each field trip
* **`r no_track_observations` records** retrieved from WAStD API on 
  `r track_data_retrieved_on` GMT+08 when compiling this workbook
* Track observations span **`r earliest_track_observation` - `r latest_track_observation` GMT+08**

## Tagging of nesting turtles

* Nesting turtles recorded on paper data sheets, entered and QA'd in WAMTRAM
* Data exported from WAMTRAM master db (scripted) into CSV and saved to 
  internal data catalogue
* Data ingested (scripted) from CSV into WAStD
* **`r no_tag_observations` records** retrieved from WAStD API on 
  `r tag_data_retrieved_on` GMT+08 when compiling this workbook
* Tag observations span **`r earliest_tag_observation` - `r latest_tag_observation` GMT+08**

## Interactive datatable: Tracks
```{r}
DT::datatable(tracks)
```

## Interactive datatable: Nesting turtles
```{r}
DT::datatable(tags)
```


## Interactive map
Hover-scroll to zoom, click features to inspect.
```{r}
track <- makeAwesomeIcon(icon="home", markerColor="green")
tag <- makeAwesomeIcon(icon="tag", markerColor="blue")
leaflet(tracks) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  setView(lng=115.0, lat=-21.45, zoom=12) %>%
  addAwesomeMarkers(~longitude, ~latitude,
                    data=tracks, label=~species,
                    icon=track,
                    popup=~paste(nest_age, species, nest_type, datetime)) %>%
  addAwesomeMarkers(~longitude, ~latitude, data=tags, label=~species,
                    icon=tag,
                    popup=~paste(species, activity, datetime))
```

# Nesting effort
q.TODO: include tagging from here on.
## New tracks by species
```{r}
ggplot(tally_fresh, aes(x=date, y=n, colour=nest_type)) +
  geom_point() + facet_wrap("species", ncol=1)
```

**Note** Track and nest counts within the tagging sector (Jetty to Chevron) 
from the night of 20/11/2016 to 21/11/2016 were not recorded
in the ODK Collect app the morning after, as wind and foot traffic during the night
rendered the tracks unreadable. The tracks and nests were recorded on paper data
sheets and will turn up in the tagging database WAMTRAM2.

November 20-22 were windy, and tracks on the south side of the western end were
likely blown over. This will result in false absence of tracks on 20/11/2016-22/11/2016.
Wind conditions after 22/11/2016 are unknown and may also decrease the number of 
detected tracks.

Durign the field trip in Feb 2017 (exact dates to be confirmed), a cyclone 
prevented track counts on some days and may have blown away many tracks on other 
days, resulting in days without track counts as well as days with falsely low 
track counts.

There may be more periods with artificially low track count.

**TODO** identify periods of artificially low track count from field diary

**TODO** enter surveys into WAStD, annotate with observations on weather, methodology,
any known biases on recorded data.

## Nesting effort
```{r}
gg_nesting_abundance <- ggplot(nesting_success, aes(x=date)) +
  geom_bar(aes(y=all), stat = "identity", color = "black", fill = "black") +
  geom_bar(aes(y=nesting), stat = "identity", color = "gray", fill="gray") +
  ggtitle("Nesting effort at Thevenard Is") +
  labs(x="Date", y="Number of nesting emergences") +
  facet_wrap("species", ncol=1)
gg_nesting_abundance
ggsave("data/nesting_abundance.pdf", gg_nesting_abundance, width=7, height=7)
```

## Nesting success
```{r}
gg_nesting_success <- ggplot(nesting_success, aes(x = date, y = nesting_success)) +
  ggtitle("Nesting success at Thevenard Is") +
  geom_bar(stat = "identity") +
  labs(x = "Date", y = "Success rate of nesting emergences") +
  facet_wrap("species", ncol = 1)
gg_nesting_success
ggsave("data/nesting_success.pdf", gg_nesting_success, width=7, height=7)
```


## Modelling the nesting seasons
This section aims to determine beginning, peak, and end of nesting season per 
species at the given location.

## Spatial and temporal patterns of abundance
Spatial and temporal patterns of species abundance (daily species tallies) (PCNM)

### Species profiles
Observations have to be binned into spatial (rectangular grid cells) and 
temporal (days) buckets and pivoted into species profiles.

```{r}
grd = readOGR("thv_grid.geojson", "OGRGeoJSON")
head(tracks)
library(sp)
library(maptools)
library(tidyr)    
d <- tracks

# Turn data into SpatialPointsDataFrame (R's "Shapefile"")
wgs84 = CRS('+proj=longlat +datum=WGS84 +no_defs')
d.sp <- SpatialPoints(coords=select(d, longitude, latitude), proj4string=wgs84)
d.spdf <- SpatialPointsDataFrame(d.sp, data=d, proj4string=wgs84)

# Join data to grid polygons
d.spdf.grd <- spCbind(d.spdf, over(d.spdf, grd))

# Create species profiles for species track abundance per grid cell and date
dd <- d.spdf.grd@data %>% 
  filter(!is.na(id)) %>%
  group_by(date, id, species) %>% 
  tally(sort=F) %>% 
  ungroup() %>%
  spread(species, n, fill=0) %>% left_join(grd, by="id", copy=T)
colnames(dd) <- make.names(colnames(dd))
DT::datatable(dd)

X.site.xy <- grd@data %>% select(xmin, ymin) %>% as.data.frame()
Xs <- dd %>% select(xmin, ymin)
Xt <- difftime(dd$date, origin)
Y.in <- dd %>% select(-id, -date, -xmin, -xmax, -ymin, -ymax)
```

### Correlations between variables
```{r}
pairs(Y.in, main="Correlations between species")
```
The nesting emergence abundance between Flatbacks and Greens seem to correlate inversely.

### Skewness in variables

* Histograms of Y and X will show the distribution of variable values.
* Expected: normal or uniform distribution.
* Right-skewed distributions can be log-transformed.
* Left-skewed distributions can be sqrt-transformed.
* Sparse observations should be Hellinger-transformed to reduce false similarity 
between sites through shared absence (which might be undersampling rather than 
true absence).

```{r}
qplot(Y.in$"chelonia.mydas", geom="histogram") 
qplot(Y.in$"natator.depressus", geom="histogram")
```
The main species look a bit left-skewed and show many absences.

The Hellinger transformation will help reduce false similarity through shared absences.

```{r}
library(vegan)
Y.hel <- Y.in %>% decostand("hellinger")
pairs(Y.hel)
qplot(Y.hel$"chelonia.mydas", geom="histogram")
qplot(Y.hel$"natator.depressus", geom="histogram")
```

Remove linear spatial trends, lest they eat up explanatory power.

```{r}
Y <- residuals(rda(Y.hel, Xs))
pairs(Y)
```


### PCNM
party time.
```{r}
Xs.site.pcnm <- pcnm(dist(X.site.xy))
sites_pcnm <- cbind(grd@data, scores(Xs.site.pcnm))
surveys_pcnm <- left_join(dd, sites_pcnm, by="id")
Xs.scores <- select(surveys_pcnm, starts_with("PCNM"))
Xt.pcnm <- pcnm(dist(Xt))
Xt.scores <- as.data.frame(scores(Xt.pcnm))

# TODO Moran's I
Xs.sel <- forward.sel(Y, Xs.scores)
Xt.sel <- forward.sel(Y, Xt.scores)
XS <- Xs.scores %>% select(Xs.sel$order)
XT <- Xt.scores %>% select(Xt.sel$order)

Xs.sel
Xt.sel
Y.vp <- varpart(Y, ~as.matrix(XS), ~as.matrix(XT))
Y.vp
plot(Y.vp)
```

Outcome: 

* Spatial patterns explain a total of 4% of the variance.
* Temporal patterns explain a total of 11% of the variance.
* Another 1% of the variance is co-explained by both spatial and temporal patterns.

## Spatial patterns
```{r}
plot.xs <- function(nr, coords, scores, fs){
  fig <- ordisurf(coords, scores[,nr], bubble=3,
                  main=paste("Spatial pattern", fs[nr,2]), 
                  sub=paste("explains", round(as.numeric(fs[nr,3]), digits=3)*100, 
                            "% variance"))
  pdf(paste0("data/spatial_pattern_", nr, ".pdf"), width=6, height=6)
  fig
  dev.off()
  fig
}

lapply(seq_len(nrow(Xs.sel)), 
       plot.xs, 
       select(sites_pcnm, xmin, ymin), 
       select(sites_pcnm, starts_with("PCNM")), 
       Xs.sel)
```

### Temporal patterns
```{r}

#' Create a scatterplot of PCNM values against dates.
#' 
#' nr: The row number of the forward.sel dataframe
#' dates: a vector of ymd dates
#' scores: a data.frame of PCNM scores
#' fs: an output data.frame of forward.sel
plot.xt <- function(nr, dates, scores, fs){
  fig <- plot(x=ymd(dates), y=scores[,nr], type="p",
              xlab="", ylab=paste("PCNM", fs[nr,2]), 
              main=paste("Temporal pattern", fs[nr,2]), 
              sub=paste("explains", round(as.numeric(fs[nr,3]), digits=3)*100, "% variance"))
  pdf(paste0("data/temporal_pattern_", nr, ".pdf"), width=6, height=6)
  fig
  dev.off()
  fig
}

# Plot all significant temporal PCNM variables.
lapply(Xt.sel$order, plot.xt, dd$date, XT, Xt.sel)
```

A spot of modelling!
```{r}
XSm <- as.matrix(XS)
XTm <- as.matrix(XT)
Y.rda <- rda(Y ~ XSm + XTm)
ordiplot(Y.rda)
```
# Questions

* Are there any hotspots of different species?
* Does the tagging area cover the main nesting area?

```{r, echo=FALSE}
setwd("~/projects/turtle-scripts")
```
