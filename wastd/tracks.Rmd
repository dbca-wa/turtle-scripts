---
title: "Turtle tracks"
author: "Florian Mayer, Dept Parks & Wildlife WA"
date: "12/02/2017"
output: html_document
---

```{r r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/projects/turtle-scripts/wastd")
# https://cran.r-project.org/web/packages/tidyjson/vignettes/introduction-to-tidyjson.html
# install.packages("tidyjson") # a better way to flatten JSON to CSV?
library(httr)
library(plyr)
library(dplyr)
library(lubridate)
library(tidyjson)
library(DT)
library(leaflet)
library(ggplot2)
# if (!require("devtools")) install.packages("devtools")
# devtools::install_github("ropensci/geojsonio")
# library(geojsonio)
# library(sp)
library(rgdal)
# install.packages("../data/packfor_0.0-8.tar.gz", repos = NULL, type = "source")
library(packfor)

if (file.exists("../config/setup.R")) source("../config/setup.R")
api <- "https://strandings.dpaw.wa.gov.au/api/1/"
pars <- "?taxon=Cheloniidae&limit=10000&format=json"
hdr <- c(Authorization = APITOKEN)
res_trk <- httr::GET(paste0(api, "turtle-nest-encounters/", pars), 
                     add_headers(.headers = hdr)) %>% content("text", encoding="utf-8") %>% as.tbl_json()
data_trk_json <- attr(res_trk, "JSON")[[1]]$results

res_tag <- httr::GET(paste0(api, "animal-encounters/", pars), 
                     add_headers(.headers = hdr)) %>% content("text", encoding="utf-8") %>% as.tbl_json()
data_tag_json <- attr(res_tag, "JSON")[[1]]$results

flatten_trk <- function(li){
  datetime <- li$when
  lon <- li$where$longitude
  lat <- li$where$latitude
  species <- li$species
  nest_age <- li$nest_age
  nest_type <- li$nest_type
  out <- c(datetime, lon, lat, species, nest_age, nest_type)
  out
}

flatten_tag <- function(li){
  datetime <- li$when
  lon <- li$where$longitude
  lat <- li$where$latitude
  species <- li$species
  health <- li$health
  activity <- li$activity
  out <- c(datetime, lon, lat, species, health, activity)
  out
}

utc <- "UTC"
gmt08 <- "Australia/Perth"
ord <- c("YmdHMSz", "adbYHMS")

tracks <- ldply(data_track_json, flatten_track_observations) %>% tbl_df()
colnames(tracks) <- c("datetime", "longitude", "latitude", "species", "nest_age", "nest_type")
tracks <- mutate(tracks,
            datetime=with_tz(parse_date_time(datetime, orders=c("YmdHMSz"), tz=utc), tzone=gmt08),
            longitude=as.numeric(longitude),
            latitude=as.numeric(latitude)
            ) %>%
  mutate(date=as_date(datetime))
# glimpse(d)
save(tracks, file="data/tracks.Rda")
load("data/tracks.Rda")

tags <- ldply(data_tag_json, flatten_track_observations) %>% tbl_df()
colnames(tags) <- c("datetime", "longitude", "latitude", "species", "health", "activity")
tags <- mutate(tags,
            datetime=with_tz(parse_date_time(datetime, orders=c("YmdHMSz"), tz=utc), tzone=gmt08),
            longitude=as.numeric(longitude),
            latitude=as.numeric(latitude)
            ) %>%
  mutate(date=as_date(datetime))
# glimpse(d)
save(tags, file="data/tags.Rda")
load("data/tags.Rda")



# Metadata on data currency
data_retrieved_on <- with_tz(parse_date_time(res$headers$date, orders=ord, tz=utc), tzone=gmt08)
no_observations <- nrow(d)
earliest_observation <- with_tz(min(d$datetime), tzone=gmt08)
latest_observation <- with_tz(max(d$datetime), tzone=gmt08)

# Tally all tracks
tally_data <- d %>%
  group_by(date, species, nest_age) %>% tally(sort=F) %>% ungroup()

# Tally only "fresh" tracks
tally_fresh <- d %>% filter(nest_age=="fresh") %>%
  group_by(date, species, nest_type) %>% tally(sort=F) %>% ungroup()

# Tally all fresh tracks with nest
tally_all <- d %>% 
    filter(nest_age=='fresh') %>%
    group_by(date, species) %>% tally(sort=F) %>% ungroup()
colnames(tally_all) <- c('date', 'species', 'all')

# Tally fresh tracks with nest
tally_nesting <- d %>% 
    filter(nest_age=='fresh', nest_type=='successful-crawl') %>%
    group_by(date, species) %>% tally(sort=F) %>% ungroup()
colnames(tally_nesting) <- c('date', 'species', 'nesting')


# Join successful nesting crawls with all nesting crawls
nesting <- left_join(tally_all, tally_nesting, by=c('date','species')) 
nesting[is.na(nesting)] <- 0
nesting_success <- mutate(nesting, nesting_success=nesting/all)

```

# Data

* Data recorded on Android tablets using digital data capture software ODK Collect
* Forms "TrackCount 0.10" (Nov-Dec 2016) and "Track or Treat 0.26" (Feb 2017)
* Data warehouse ODK Aggregate at [dpaw-data.appspot.com](https://dpaw-data.appspot.com/)
* Data exported manually from dpaw-data as JSON and ingested (scripted) into
  [WAStD](https://strandings.dpaw.wa.gov.au/) after each field trip
* **`r no_observations` records** retrieved from WAStD API on 
  `r data_retrieved_on` GMT+08 when compiling this workbook
* Observations span **`r earliest_observation` - `r latest_observation` GMT+08**


## Interactive datatable
```{r}
DT::datatable(d)
```

## Interactive map
Hover-scroll to zoom, click features to inspect.
```{r}
leaflet(d) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  setView(lng=115.0, lat=-21.45, zoom=12) %>%
  addAwesomeMarkers(~longitude, ~latitude, label=~species,
                    popup=~paste(nest_age, species, nest_type, datetime))
```

# Nesting effort
## New tracks by species
```{r}
ggplot(tally_fresh, aes(x=date, y=n, colour=nest_type)) +
  geom_point() + facet_wrap("species", ncol=1)
```

**Note** Track and nest counts within the tagging sector (Jetty to Chevron) 
from the night of 20/11/2016 to 21/11/2016 were not recorded
in the ODK Collect app the morning after, as wind and foot traffic during the night
rendered the tracks unreadable. The tracks and nests were recorded on paper data
sheets and will turn up in the tagging database WAMTRAM2.

November 20-22 were windy, and tracks on the south side of the western end were
likely blown over. This will result in false absence of tracks on 20/11/2016-22/11/2016.
Wind conditions after 22/11/2016 are unknown and may also decrease the number of 
detected tracks.

Durign the field trip in Feb 2017 (exact dates to be confirmed), a cyclone 
prevented track counts on some days and may have blown away many tracks on other 
days, resulting in days without track counts as well as days with falsely low 
track counts.

There may be more periods with artificially low track count.

**TODO** identify periods of artificially low track count from field diary

**TODO** enter surveys into WAStD, annotate with observations on weather, methodology,
any known biases on recorded data.

## Nesting effort (hello sabrina!)
```{r}
ggplot(nesting_success, aes(x=date, colour=species)) +
    geom_point(aes(y=all, shape="all")) + 
    geom_point(aes(y=nesting, shape="successful")) + 
    ggtitle("Nesting effort at Thevenard Is") +
    labs(x="Date", y="Number of nesting emergences") +
    facet_wrap("species", ncol=1)
```

## Nesting success
```{r}
ggplot(nesting_success, aes(x=date, y=nesting_success, colour=species)) +
    geom_point() + ggtitle("Nesting success at Thevenard Is") +
    labs(x="Date", y="Success rate of nesting emergences") +
    facet_wrap("species", ncol=1)
```


## Modelling the nesting seasons
Beginning, peak, end of nesting season per species at location

**TODO fit model to data per species**

## Spatial and temporal patterns of abundance
Spatial and temporal patterns of species abundance (daily species tallies) (PCNM)

### Species profiles
Observations have to be binned into spatial (rectangular grid cells) and 
temporal (days) buckets and pivoted into species profiles.

```{r}
grd = readOGR("thv_grid.geojson", "OGRGeoJSON")
head(d)
library(sp)
library(maptools)
library(tidyr)    

# Turn data into SpatialPointsDataFrame (R's "Shapefile"")
wgs84 = CRS('+proj=longlat +datum=WGS84 +no_defs')
d.sp <- SpatialPoints(coords=select(d, longitude, latitude), proj4string=wgs84)
d.spdf <- SpatialPointsDataFrame(d.sp, data=d, proj4string=wgs84)

# Join data to grid polygons
d.spdf.grd <- spCbind(d.spdf, over(d.spdf, grd))

# Create species profiles for species track abundance per grid cell and date
dd <- d.spdf.grd@data %>% 
    filter(!is.na(id)) %>%
    group_by(date, id, species) %>% 
    tally(sort=F) %>% 
    ungroup() %>%
    spread(species, n, fill=0) %>% left_join(grd, by="id", copy=T)
colnames(dd) <- make.names(colnames(dd))
DT::datatable(dd)

X.site.xy <- grd@data %>% select(xmin, ymin) %>% as.data.frame()
Xs <- dd %>% select(xmin, ymin)
Xt <- difftime(dd$date, origin)
Y.in <- dd %>% select(-id, -date, -xmin, -xmax, -ymin, -ymax)
```

### Correlations between variables
```{r}
pairs(Y.in, main="Correlations between species")
```
The nesting emergence abundance between Flatbacks and Greens seem to correlate inversely.

### Skewness in variables

* Histograms of Y and X will show the distribution of variable values.
* Expected: normal or uniform distribution.
* Right-skewed distributions can be log-transformed.
* Left-skewed distributions can be sqrt-transformed.
* Sparse observations should be Hellinger-transformed to reduce false similarity 
  between sites through shared absence (which might be undersampling rather than 
  true absence).
  
```{r}
qplot(Y.in$"Chelonia.mydas", geom="histogram") 
qplot(Y.in$"Natator.depressus", geom="histogram")
```
The main species look a bit left-skewed and show many absences.

The Hellinger transformation will help reduce false similarity through shared absences.

```{r}
library(vegan)
Y.hel <- Y.in %>% decostand("hellinger")
pairs(Y.hel)
qplot(Y.hel$"Chelonia.mydas", geom="histogram")
qplot(Y.hel$"Natator.depressus", geom="histogram")
```

Remove linear spatial trends, lest they eat up explanatory power.

```{r}
Y <- residuals(rda(Y.hel, Xs))
pairs(Y)
```


### PCNM
party time.
```{r}
Xs.site.pcnm <- pcnm(dist(X.site.xy))
sites_pcnm <- cbind(grd@data, scores(Xs.site.pcnm))
surveys_pcnm <- left_join(dd, sites_pcnm, by="id")
Xs.scores <- select(surveys_pcnm, starts_with("PCNM"))
Xt.pcnm <- pcnm(dist(Xt))
Xt.scores <- as.data.frame(scores(Xt.pcnm))

# TODO Moran's I
Xs.sel <- forward.sel(Y, Xs.scores)
Xt.sel <- forward.sel(Y, Xt.scores)
XS <- Xs.scores %>% select(Xs.sel$order)
XT <- Xt.scores %>% select(Xt.sel$order)

Xs.sel
Xt.sel
Y.vp <- varpart(Y, ~as.matrix(XS), ~as.matrix(XT))
Y.vp
plot(Y.vp)
```

Outcome: 

* Spatial patterns explain a total of 4% of the variance.
* Temporal patterns explain a total of 12% of the variance.

## Spatial patterns
```{r}
plot.xs <- function(nr, coords, scores, fs){
  fig <- ordisurf(coords, scores[,nr], bubble=3,
           main=paste("Spatial pattern", fs[nr,2]), 
           sub=paste("explains", round(as.numeric(fs[nr,3]), digits=3)*100, 
                     "% variance"))
  pdf(paste0("data/spatial_pattern_", nr, ".pdf"), width=6, height=6)
  fig
  dev.off()
  fig
}

lapply(seq_len(nrow(Xs.sel)), 
       plot.xs, 
       select(sites_pcnm, xmin, ymin), 
       select(sites_pcnm, starts_with("PCNM")), 
       Xs.sel)
```

### Temporal patterns
```{r}

#' Create a scatterplot of PCNM values against dates.
#' 
#' nr: The row number of the forward.sel dataframe
#' dates: a vector of ymd dates
#' scores: a data.frame of PCNM scores
#' fs: an output data.frame of forward.sel
plot.xt <- function(nr, dates, scores, fs){
  fig <- plot(x=ymd(dates), y=scores[,nr], type="p",
     xlab="", ylab=paste("PCNM", fs[nr,2]), 
     main=paste("Temporal pattern", fs[nr,2]), 
     sub=paste("explains", round(as.numeric(fs[nr,3]), digits=3)*100, "% variance"))
  pdf(paste0("data/temporal_pattern_", nr, ".pdf"), width=6, height=6)
  fig
  dev.off()
  fig
}

# Plot all significant temporal PCNM variables.
lapply(Xt.sel$order, plot.xt, dd$date, XT, Xt.sel)
```

A spot of modelling!
```{r}
XSm <- as.matrix(XS)
XTm <- as.matrix(XT)
Y.rda <- rda(Y ~ XSm + XTm)
ordiplot(Y.rda)
```
# Questions

* Are there any hotspots of different species?
* Does the tagging area cover the main nesting area?

**TODO PCNM analysis**

```{r, echo=FALSE}
setwd("~/projects/turtle-scripts")
```
