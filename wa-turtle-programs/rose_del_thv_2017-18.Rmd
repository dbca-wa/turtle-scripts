---
title: "Season review 2017-2018: Delambre and Thevenard Islands"
author: "Marine Turtles WA"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    fig_width: 10
    fig_height: 6
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
source("tracks_setup.R")
source("tracks_helpers.R")
source("load_data.R")
```

# Caveat
Particular to Thevenard Island is that all training occurs at the accommodation 
area, which is registered  as a separate site, and explicitly not included in 
the data analysed here.

Training and test data from Delambre Island are not yet separated out.

Data from Rosemary Islands was stuck as unfinalised forms on devices. Delivered training refresher.

# Data
```{r load_data}
tracks_thv <- tracks_all %>% filter_thv() %>% filter_realspecies() %>% add_nest_labels()
tracks_di <- tracks_all %>% filter_di() %>% filter_realspecies() %>% add_nest_labels()
tracks_ri <- tracks_all %>% filter_ri() %>% filter_realspecies() %>% add_nest_labels()

surveys_thv <- surveys %>% filter_thv()
surveys_di <- surveys %>% filter_di()
surveys_ri <- surveys %>% filter_ri()

dist_thv <- disturbance %>% filter_thv()
dist_di <- disturbance %>% filter_di()
dist_ri <- disturbance %>% filter_ri()

prefix_thv <- "THV"
prefix_di <- "DEL"
prefix_ri <- "ROS"

placename_thv <- "Thevenard Is"
placename_di <- "Delambre Is"
placename_ri <- "Rosemary Is"
```


# QA
This section identifies tracks and disturbances outside known sites, missing surveys, and surveys requiring editing.
We show data from all regions as not to miss any stray records - ignore data not relevant to this analysis.

## Tracks outside known sites
Review whether there are stray tracks close to this program's sites.

* WAStD sites missing (new sites) or boundaries set too narrow. 
  Extend sites, re-save stray tracks to auto-repair their site affiliation.
* Training records close to site (but not meant to be within site).
  Change confirmed training records outside training areas to "Hatchback turtles" 
  and mark as "curated" to prevent from being overwritten by repeated data loading.
* Note: re-run uncached data import after changing tracks.

```{r tracks_missing_sites}
tracks_all %>% 
  filter_nosite() %>%
  filter_realspecies() %>%
  add_nest_labels() %>% 
  map_tracks()
```

## Disturbance outside known sites
Review disturbances close to this program's sites. It is safe to ignore other disturbances.

Disturbances can either be legitimate, although opportunistic, records, or training
records.

* Training records: set to "Other, see comments", mention "training" in comments,
  ideally instruct data collectors to photograph their writing board with "training"
  written on it to make absolutely clear that this record is a training record.

```{r dist_missing_sites}
disturbance %>% filter_nosite() %>% wastdr::map_dist()
```

## Surveys in WAStD
TODO change to islands

Curators are to QA 
[all `r placename` surveys on WAStD](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__in=35,45) following the 
[QA instructions for surveys](https://wastd.readthedocs.io/data_curators.html#data-flow-of-surveys).

Split up per site:

* [Cemetary Beach](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=35)
* [Pretty Pool Beach](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=45)

## Surveys missing end
Where a "Site Visit End" form was forgotten, `end_source_id` is empty, and the duration is set to 6h. 
These surveys should be closed a few minutes after the last recorded track or disturbance.

Surveys with missing end contribute to an over-estimation of survey effort.

This task will be automated soon.
  
```{r surveys_missing_end}
surveys_thv %>% 
  dplyr::filter(is.na(end_source_id)) %>%
  dplyr::select(-site_type, -site_id, -reporter_username, -reporter_id, -id, -absolute_admin_url) %>% 
  dt

surveys_di %>% 
  dplyr::filter(is.na(end_source_id)) %>%
  dplyr::select(-site_type, -site_id, -reporter_username, -reporter_id, -id, -absolute_admin_url) %>% 
  dt

surveys_ri %>% 
  dplyr::filter(is.na(end_source_id)) %>%
  dplyr::select(-site_type, -site_id, -reporter_username, -reporter_id, -id, -absolute_admin_url) %>% 
  dt
```

## Provided username mismatches WAStD users
TODO: define QA rules for mismatches of usernames as (possibly mis)typed by data collectors vs 
[WAStD users](https://tsc.dbca.wa.gov.au/admin/users/user/).

```{r name_mismatch}
surveys_thv %>% filter_surveys_requiring_qa %>% dt
surveys_di %>% filter_surveys_requiring_qa %>% dt
surveys_ri %>% filter_surveys_requiring_qa %>% dt
```


## Surveys in WAStD
TODO change to islands
Curators are to QA [all Thevenard surveys on WAStD](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__in=25,26,27,46,47) following the 
[QA instructions for surveys](https://wastd.readthedocs.io/data_curators.html#data-flow-of-surveys).

Split up per site:

* [Cooling Water Beach](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=26)
* [Bells Beach](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=25)
* [Yacht Club Beach](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=27)
* [Boat Beach](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=46)
* [Cleaverville Beach 1](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=47)

## Surveys missing Site Visit End
Where a "Site Visit End" form was forgotten, `end_source_id` is empty, and the duration is set to 6h. 
These surveys should be closed a few minutes after the last recorded track or disturbance.

Surveys with missing end contribute to an over-estimation of survey effort.

This task will be automated soon.
  
```{r}
surveys_thv %>% 
  dplyr::filter(is.na(end_source_id)) %>%
  dplyr::select(-site_type, -site_id, -reporter_username, -reporter_id, -id, -absolute_admin_url) %>% 
  DT::datatable(escape = FALSE, rownames = FALSE)

surveys_di %>% 
  dplyr::filter(is.na(end_source_id)) %>%
  dplyr::select(-site_type, -site_id, -reporter_username, -reporter_id, -id, -absolute_admin_url) %>% 
  DT::datatable(escape = FALSE, rownames = FALSE)

surveys_ri %>% 
  dplyr::filter(is.na(end_source_id)) %>%
  dplyr::select(-site_type, -site_id, -reporter_username, -reporter_id, -id, -absolute_admin_url) %>% 
  DT::datatable(escape = FALSE, rownames = FALSE)
```

## Provided username mismatches WAStD users
TODO: define QA rules for mismatches of usernames as (possibly mis)typed by data collectors vs 
[WAStD users](https://tsc.dbca.wa.gov.au/admin/users/user/).

```{r}
surveys_thv %>% filter_surveys_requiring_qa %>% DT::datatable(escape = FALSE, rownames = FALSE)
surveys_di %>% filter_surveys_requiring_qa %>% DT::datatable(escape = FALSE, rownames = FALSE)
surveys_ri %>% filter_surveys_requiring_qa %>% DT::datatable(escape = FALSE, rownames = FALSE)
```


# Background
Source: Milani Chaloupka, presentation to DBCA / NWS committee 8/5/2018.

Demographic focus is essential for diagnosing population status and trend.
Survival rates, conditional breeding rates, hatchling production rates, recruitment rates and population abundance.

Three major flatback pops in Pilbara: Delambre 3.5k nesting/y, 
Mundabullangana 2.5k nesting/y, Barrow Is 2k/y.
Biggest pop in GBR is 700 nests/y.

Milani presented: 

* Bayesian gompertz state-space model trend
* Random effects forest plot with rookery specific posterior distribution

# Season summary

## Going digital
Entering and proofreading a record takes about 2 minutes with full concentration.
By going digital, data entry and proofreading are fully automated.
This season, the Volunteers at Thevenard have saved 
`r (nrow(tracks_thv) + nrow(surveys_thv)*2 + nrow(dist_thv)) * 2 / 60` hours of mind-numbing data entry
and proofreading work for `r nrow(tracks_thv)` Track or Treats and 
`r nrow(surveys_thv)*2` Site Visit Starts/Ends. 

Time savings Delambre: `r (nrow(tracks_di) + nrow(surveys_di)*2 + nrow(dist_di)) * 2 / 60` hours for `r nrow(tracks_di)` Track or Treats and 
`r nrow(surveys_di)*2` Site Visit Starts/Ends. 

TODO RI

## Maps
```{r map_overall}
tracks_thv %>% map_tracks()
tracks_di %>% map_tracks()
tracks_ri %>% map_tracks()
```

## Nesting abundance
### Thevenard
```{r tracks_all_sectors_thv}
tracks_thv %>% species_by_type() %>% kable()
```

```{r nesting_success_thv}
tracks_thv %>% tracks_ts(placename="Thevenard Is")
```

```{r hatching_emergence_success_thv}
tracks_thv %>%
  hatching_emergence_success() %>%
  DT::datatable(.,
    caption = "Hatching and emergence success summary",
    options = list(paging = F)
  )
```

```{r plot_track_effort_thv, warning = F}
label <- "thv"
nests <- tracks_thv %>% track_success()
nests %>% ggplot_track_success_by_date("natator-depressus", placename_thv, prefix_thv)
nests %>% ggplot_track_success_by_date("chelonia-mydas", placename_thv, prefix_thv)
nests %>% ggplot_track_successrate_by_date("natator-depressus", placename_thv, prefix_thv)
nests %>% ggplot_track_successrate_by_date("chelonia-mydas", placename_thv, prefix_thv)
nests %>% track_success_by_species() %>% datatable(.,
  caption = "Nesting success of fresh tracks (excl. nests without tracks and tagging)"
)
```

### Delambre
```{r tracks_all_sectors_di}
tracks_di %>% species_by_type() %>% kable()
```

```{r nesting_success_di}
tracks_di %>% tracks_ts(placename = "Delambre Island")
```


```{r fig_fb_hs_es_di, fig.width=7,fig.height=5}
nests_with_hs_di <- tracks_di %>%
  filter(
    nest_type == "hatched-nest",
    hatching_success >= 0,
    species == "natator-depressus"
  )

ggplot(nests_with_hs_di, aes(group = date, x = date)) +
  geom_boxplot(aes(y = as.numeric(hatching_success)), na.rm = TRUE, color = "black") +
  geom_boxplot(aes(y = as.numeric(emergence_success)), na.rm = TRUE, color = "gray") +
  xlab("Date") +
  ylab("Success rate in percent") +
  ggtitle("Flatback hatching (black) and emergence (grey) success",
    subtitle = paste("From", nrow(nests_with_hs_di), "nests")) +
  ggplot2::scale_x_date(
      date_breaks = "1 month",
      date_minor_breaks = "1 week",
      labels = scales::date_format("%d %b %Y")) +
    ggplot2::scale_y_continuous(limits = c(0, NA)) +
    ggplot2::theme_classic() +
  ggsave("flatback_hs_es_di.pdf", width = 7, height = 5)
```

```{r plot_track_effort_di, fig.height=5, fig.width=7, warning = F}
nests <- tracks_di %>% track_success()
nests %>% ggplot_track_success_by_date("natator-depressus", placename_di, prefix_di)
nests %>% ggplot_track_success_by_date("chelonia-mydas", placename_di, prefix_di)
nests %>% ggplot_track_successrate_by_date("natator-depressus", placename_di, prefix_di)
nests %>% ggplot_track_successrate_by_date("chelonia-mydas", placename_di, prefix_di)
nests %>% track_success_by_species() %>% datatable(.,
  caption = "Nesting success of fresh tracks (excl. nests without tracks and tagging)"
)
```


```{r hatching_emergence_success_di}
tracks_di %>%
  hatching_emergence_success() %>%
  DT::datatable(.,
    caption = "Hatching and emergence success summary",
    options = list(paging = F)
  )
```

### Rosemary
```{r tracks_all_sectors_ri}
tracks_ri %>% species_by_type() %>% kable()
```

```{r nesting_success_ri}
tracks_ri %>% tracks_ts(placename="Rosemary Island")
```

No nest excavations on RI, skipping hatching success plot.
```{r fig_fb_hs_es_ri, fig.width=7,fig.height=5, eval=F}
nests_with_hs_ri <- tracks_ri %>%
  filter(
    nest_type == "hatched-nest",
    hatching_success >= 0,
    species == "natator-depressus"
  )

ggplot(nests_with_hs_ri, aes(group = date, x = date)) +
  geom_boxplot(aes(y = as.numeric(hatching_success)), 
               na.rm = TRUE, color = "black") +
  geom_boxplot(aes(y = as.numeric(emergence_success)), 
               na.rm = TRUE, color = "gray") +
  xlab("Date") +
  ylab("Success rate in percent") +
  ggtitle("Flatback hatching (black) and emergence (grey) success",
          subtitle = paste("From", nrow(nests_with_hs_di), "nests")) +
  ggplot2::scale_x_date(
    date_breaks = "1 month",
    date_minor_breaks = "1 week",
    labels = scales::date_format("%d %b %Y")) +
  ggplot2::scale_y_continuous(limits = c(0, NA)) +
  ggplot2::theme_classic() +
  ggsave("flatback_hs_es_ri.pdf", width = 7, height = 5)
```

```{r plot_track_effort_ri, fig.height=5, fig.width=7, warning = F}
nests <- tracks_ri %>% track_success()
nests %>% ggplot_track_success_by_date("natator-depressus", placename_ri, prefix_ri)
nests %>% ggplot_track_success_by_date("chelonia-mydas", placename_ri, prefix_ri)
nests %>% ggplot_track_successrate_by_date("natator-depressus", placename_ri, prefix_ri)
nests %>% ggplot_track_successrate_by_date("chelonia-mydas", placename_ri, prefix_ri)
nests %>% track_success_by_species() %>% datatable(.,
  caption = "Nesting success of fresh tracks (excl. nests without tracks and tagging)"
)
```


```{r hatching_emergence_success_ri}
tracks_ri %>%
  hatching_emergence_success() %>%
  DT::datatable(.,
    caption = "Hatching and emergence success summary",
    options = list(paging = F)
  )
```


## Disturbance and predation
Disturbed nests are captured through form "Track or Treat" and appear here
as "tracks" with "disturbance" recorded as "present".

General signs of disturbance or predator presence are recorded through form 
"Fox Sake" and appear here as "dist_(place)".

### Disturbance and predation of nests Thevenard
Turtle nests with recorded disturbance or predation.

```{r}
disturbed_nests_thv <- tracks_thv %>% filter(disturbance == "present")
disturbed_nests_thv %>%map_tracks()
```

There were **`r count(disturbed_nests_thv)` reports** of disturbed nests. Caveat: QA to exclude possible training records.


### Disturbance and predation of nests Delambre
Turtle nests with recorded disturbance or predation.

```{r}
disturbed_nests_di <- tracks_di %>% filter(disturbance == "present")
disturbed_nests_di %>% map_tracks()
```

There were **`r count(disturbed_nests_di)` reports** of disturbed nests. Caveat: QA to exclude possible training records.

### Disturbance and predation of nests Rosemary
Turtle nests with recorded disturbance or predation.

```{r}
disturbed_nests_ri <- tracks_ri %>% filter(disturbance == "present")
disturbed_nests_ri %>% map_tracks()
```

There were **`r count(disturbed_nests_ri)` reports** of disturbed nests. Caveat: QA to exclude possible training records.


Coming soon: details of disturbance to nests.

### General disturbance
Coming soon: map.

There were **`r count(dist_thv)` reports** of general disturbance or predator presence on Thevenard Is, and **`r count(dist_di)` reports** on Delambre Is.

```{r}
dist_thv %>% group_by(disturbance_cause, season) %>% tally %>% arrange(-n) %>% kable
dist_thv %>% map_dist

dist_di %>% group_by(disturbance_cause, season) %>% tally %>% arrange(-n) %>% kable
dist_di %>% map_dist

dist_ri %>% group_by(disturbance_cause, season) %>% tally %>% arrange(-n) %>% kable
dist_ri %>% map_dist
```


## Survey count

### Caveat
* Surveys with missing end points are auto-closed after 6 hours. 
* Data includes training surveys.

Both factors contribute to over-estimation of effort.

```{r survey_count}
surveys_thv %>% survey_count_heatmap(placename_thv, prefix_thv)
surveys_thv %>% list_survey_count(placename_thv)
surveys_thv %>% survey_hours_heatmap(placename_thv, prefix_thv)
surveys_thv %>% list_survey_effort(placename_thv)

surveys_di %>% survey_count_heatmap(placename_di, prefix_di)
surveys_di %>% list_survey_count(placename_di)
surveys_di %>% survey_hours_heatmap(placename_di, prefix_di)
surveys_di %>% list_survey_effort(placename_di)

surveys_ri %>% survey_count_heatmap(placename_ri, prefix_ri)
surveys_ri %>% list_survey_count(placename_ri)
surveys_ri %>% survey_hours_heatmap(placename_ri, prefix_ri)
surveys_ri %>% list_survey_effort(placename_ri)
```

## Survey effort per primary reporter
Q Which volunteer did the most hours overall on survey?

### Caveat
This list only includes the primary reporter. 
This leads to under-reporting of time spent by other volunteers attending the survey.
Their names are listed in the Site Visit Start form field "comments" as free text.
To correctly report on team member effort, curators have to read the list of 
team members in the Site Visit "comments" field and attach the correct users 
to the Survey team list.
Once the surveys are comprehensively attributed to all volunteers present, this
workbook has to be updated to include the Survey team's effort.

If the primary reporter forgot to update the username in the tablet,
their survey effort on that day is incorrectly attributed to the previous reporter.
The only way to reconcile attribution is to manually compare survey usernames with
team rosters.

```{r survey_effort_by_person}
personal_effort_thv <- surveys_thv %>% survey_hours_per_person()
personal_effort_thv %>% kable()

personal_effort_di <- surveys_di %>% survey_hours_per_person()
personal_effort_di %>% kable()

personal_effort_ri <- surveys_ri %>% survey_hours_per_person()
personal_effort_ri %>% kable()
```

## Survey effort in kilometers walked
Number of surveys per sector times length of site.

At Thevenard North Beach, assuming the trip was 6 km,
`r survey_ground_covered(surveys, 28, 6, season=2017)` km were walked 
in `r survey_count(surveys, 28, season=2017)` surveys.

At Thevenard South Beach, assuming the trip was 6 km,
`r survey_ground_covered(surveys, 29, 6, season=2017)` km were walked 
in `r survey_count(surveys, 29, season=2017)` surveys.

At Thevenard Nesting Beach, assuming the trip was 1 km,
`r survey_ground_covered(surveys, 20, 1, season=2017)` km were walked 
in `r survey_count(surveys, 20, season=2017)` surveys.

At Delambre, assuming the trip was 4 km,
`r survey_ground_covered(surveys, 39, 4, season=2017)` km were walked 
in `r survey_count(surveys, 39, season=2017)` surveys.

TODO RI

# Data upload

```{r data_upload}
# d <- ckanr::package_show("turtle-tracks")
ckanr::resource_update("19294b29-a70f-45e3-b06b-fc1eefe858d2", "rose_del_thv_2017-18.html")
```

```{r data_export}
tracks_thv %>% 
  select(-obs, -photos) %>% 
  readr::write_csv(here::here("data", "tracks_thv.csv"))
surveys_thv %>% 
  readr::write_csv(here::here("data", "surveys_thv.csv"))
dist_thv %>% 
  select(-photos) %>% 
  readr::write_csv(here::here("data", "dist_thv.csv"))

tracks_di %>% 
  select(-obs, -photos) %>% 
  readr::write_csv(here::here("data", "tracks_di.csv"))
surveys_di %>% 
  readr::write_csv(here::here("data", "surveys_di.csv"))
dist_di %>% 
  select(-photos) %>% 
  readr::write_csv(here::here("data", "dist_di.csv"))

tracks_ri %>% 
  select(-obs, -photos) %>% 
  readr::write_csv(here::here("data", "tracks_ri.csv"))
surveys_ri %>% 
  readr::write_csv(here::here("data", "surveys_ri.csv"))
dist_ri %>% 
  select(-photos) %>% 
  readr::write_csv(here::here("data", "dist_ri.csv"))
```
