---
title: "Thevenard, Delambre and Rosemary Islands"
author: "Marine Turtles WA"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    fig_width: 10
    fig_height: 6
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
source("tracks_setup.R")
source("tracks_helpers.R")
source("load_data.R")
```

# Caveat
Particular to Thevenard Island is that all training occurs at the accommodation 
area, which is registered  as a separate site, and explicitly not included in the data analysed here.

Training and test data from Delambre Island are not yet separated out.

Data from Rosemary Islands was recovered from unfinalised forms on devices.

# Data
```{r load_data}
tracks_thv <- tracks_all %>% filter_thv() %>% filter_exclude_training_species() %>% add_nest_labels()
tracks_del <- tracks_all %>% filter_del() %>% filter_exclude_training_species() %>% add_nest_labels()
tracks_ros <- tracks_all %>% filter_ros() %>% filter_exclude_training_species() %>% add_nest_labels()

surveys_thv <- surveys %>% filter_thv()
surveys_del <- surveys %>% filter_del()
surveys_ros <- surveys %>% filter_ros()

dist_thv <- disturbance %>% filter_thv()
dist_del <- disturbance %>% filter_del()
dist_ros <- disturbance %>% filter_ros()

nests_thv <- nests_all %>% filter_thv()
nests_del <- nests_all %>% filter_del()
nests_ros <- nests_all %>% filter_ros()

prefix_thv <- "THV"
prefix_del <- "DEL"
prefix_ros <- "ROS"

placename_thv <- "Thevenard Is"
placename_del <- "Delambre Is"
placename_ros <- "Rosemary Is"
```


# QA
Most QA is done across all WA records and programs in the separate QA workbook.

This section identifies data requiring editing.

## Provided username mismatches WAStD users
### Thevenard Is

```{r name_mismatch_thv}
surveys_thv %>% filter_surveys_requiring_qa %>% dt
```

### Delambre Is

```{r name_mismatch_del}
surveys_del %>% filter_surveys_requiring_qa %>% dt
```

### Rosemary Is

```{r name_mismatch_ros}
surveys_ros %>% filter_surveys_requiring_qa %>% dt
```

# Background
Source: Milani Chaloupka, presentation to DBCA / NWS committee 8/5/2018.

Demographic focus is essential for diagnosing population status and trend.
Survival rates, conditional breeding rates, hatchling production rates, recruitment rates and population abundance.

Three major flatback pops in Pilbara: Delambre 3.5k nesting/y, 
Mundabullangana 2.5k nesting/y, Barrow Is 2k/y.
Biggest pop in GBR is 700 nests/y.

Milani presented: 

* Bayesian gompertz state-space model trend
* Random effects forest plot with rookery specific posterior distribution

# Season summary

## Going digital
Entering and proofreading a record takes about 2 minutes with full concentration.
By going digital, data entry and proofreading are fully automated.
This season, the Volunteers at Thevenard have saved 
`r (nrow(tracks_thv) + nrow(surveys_thv)*2 + nrow(dist_thv)) * 2 / 60` hours of mind-numbing data entry
and proofreading work for `r nrow(tracks_thv)` Track or Treats and 
`r nrow(surveys_thv)*2` Site Visit Starts/Ends. 

Time savings Delambre: `r (nrow(tracks_del) + nrow(surveys_del)*2 + nrow(dist_del)) * 2 / 60` 
hours for `r nrow(tracks_del)` Track or Treats and  `r nrow(surveys_del)*2` Site Visit Starts/Ends. 

Time savings Rosemary: `r (nrow(tracks_ros) + nrow(surveys_ros)*2 + nrow(dist_ros)) * 2 / 60` 
hours for `r nrow(tracks_del)` Track or Treats and  `r nrow(surveys_del)*2` Site Visit Starts/Ends. 

# Thevenard Nesting
## Maps
```{r map_thv}
tracks_thv %>% filter_2017() %>% map_tracks()
```


### Animated map
A [Google API key](https://developers.google.com/maps/documentation/geocoding/start?csw=1) must
be present as R environment variable `GOOGLE_MAPS_APIKEY` for the next step.

```{r map_thv_animated, warning=FALSE}
tracks_thv_2017 <- tracks_thv %>% filter_2017()
gganimate_tracks(tracks_thv_2017, placename_thv, prefix_thv)
```

### Tagged nests
The map is saved as a PNG file `r glue::glue(prefix_thv, "_tagged_nests.png")`.

```{r nests_thv}
nests_thv %>% 
  filter_2017() %>%
  map_nests() %T>%
  mapview::mapshot(file = glue::glue("{prefix_thv}_tagged_nests_2017.png"))
```

## Nesting abundance
### All beaches
```{r tracks_all_sectors_thv}
tracks_thv %>% nesting_type_by_season_species() %>% kable()
```

## Nesting by week
### All beaches
The next table show data from all sites.

```{r tracks_all_beaches_by_week_thv}
tracks_thv %>% nesting_type_by_season_week_species() %>% kable()
```

## Nesting by day
This section shows data from all sites.

```{r nesting_success_thv, warning = F}
tracks_thv %>% tracks_ts(placename_thv, prefix_thv)
nests <- tracks_thv %>% track_success()
nests %>% ggplot_track_success_by_date("natator-depressus", placename_thv, prefix_thv)
nests %>% ggplot_track_successrate_by_date("natator-depressus", placename_thv, prefix_thv)
# nests %>% ggplot_track_success_by_date("chelonia-mydas", placename_thv, prefix_thv)
# nests %>% ggplot_track_successrate_by_date("chelonia-mydas", placename_thv, prefix_thv)
nests %>% track_success_by_species() %>% DT::datatable(.,
  caption = "Nesting success of fresh tracks (excl. nests without tracks and tagging)"
)
```

## Hatching and emergence success
Values in `clutch_size_fresh` indicate the inclusion of records from tagging/nesting observations 
where eggs were counted and the "Track or Treat" turtle track count form was used to record the number of eggs.
Only rows with empty `clutch_size_fresh` show trustworthy data.

```{r hatching_emergence_success_thv}
tracks_thv %>%
  hatching_emergence_success() %>%
  DT::datatable(., caption = "Hatching and emergence success summary", options = list(paging = F))
```

## Disturbance and predation
Disturbed nests are captured through form "Track or Treat" and appear here
as "tracks" with "disturbance" recorded as "present".

General signs of disturbance or predator presence are recorded through form 
"Fox Sake" and appear here as "dist_(place)".

### Disturbance and predation of nests
Turtle nests with recorded disturbance or predation.

```{r dist_nests_thv}
disturbed_nests_thv <- tracks_thv %>% filter_2017() %>% filter(disturbance == "present")
disturbed_nests_thv %>% map_tracks()
```

There were **`r count(disturbed_nests_thv)` reports** of disturbed nests. 
Caveat: QA to exclude possible training records.

Coming soon: details of disturbance to nests.

### General disturbance
There were **`r count(dist_thv)` reports** of general disturbance or predator presence.

```{r map_dist_thv}
dist_thv %>% filter_2017 %>% group_by(disturbance_cause) %>% tally %>% arrange(-n) %>% kable
dist_thv %>% map_dist
```


# Delambre Nesting
## Maps
```{r map_del}
tracks_del %>% filter_2017() %>% map_tracks()
```


### Animated map
A [Google API key](https://developers.google.com/maps/documentation/geocoding/start?csw=1) must
be present as R environment variable `GOOGLE_MAPS_APIKEY` for the next step.

```{r map_del_animated, warning=FALSE, message=FALSE}
tracks_del %>% filter_2017() %>% gganimate_tracks(placename_del, prefix_del)
```

### Tagged nests
The map is saved as a PNG file `r glue::glue(prefix_del, "_tagged_nests.png")`.

```{r nests_del}
nests_del %>% 
  filter_2017() %>%
  map_nests() %T>%
  mapview::mapshot(file = glue::glue("{prefix_del}_tagged_nests_2017.png"))
```

## Nesting abundance
### All beaches
```{r tracks_all_sectors_del}
tracks_del %>% nesting_type_by_season_species() %>% kable()
```

## Nesting by week
### All beaches
The next table show data from all sites.

```{r tracks_all_beaches_by_week_del}
tracks_del %>% nesting_type_by_season_week_species() %>% kable()
```

## Nesting by day
This section shows data from all sites.

```{r nesting_success_del, warning = F}
tracks_del %>% tracks_ts(placename_del, prefix_del)
nests <- tracks_del %>% track_success()
nests %>% ggplot_track_success_by_date("natator-depressus", placename_del, prefix_del)
nests %>% ggplot_track_successrate_by_date("natator-depressus", placename_del, prefix_del)
nests %>% ggplot_track_success_by_date("chelonia-mydas", placename_del, prefix_del)
nests %>% ggplot_track_successrate_by_date("chelonia-mydas", placename_del, prefix_del)
nests %>% track_success_by_species() %>% DT::datatable(.,
  caption = "Nesting success of fresh tracks (excl. nests without tracks and tagging)"
)
```

## Hatching and emergence success
```{r hatching_emergence_success_del}
tracks_del %>%
  hatching_emergence_success() %>%
  DT::datatable(., caption = "Hatching and emergence success summary", options = list(paging = F))
```

## Disturbance and predation
Disturbed nests are captured through form "Track or Treat" and appear here
as "tracks" with "disturbance" recorded as "present".

General signs of disturbance or predator presence are recorded through form 
"Fox Sake" and appear here as "dist_(place)".

### Disturbance and predation of nests
Turtle nests with recorded disturbance or predation.

```{r dist_nests_del}
disturbed_nests_del <- tracks_del %>% filter_2017() %>% filter(disturbance == "present")
disturbed_nests_del %>% map_tracks()
```

There were **`r count(disturbed_nests_del)` reports** of disturbed nests. 
Caveat: QA to exclude possible training records.

Coming soon: details of disturbance to nests.

### General disturbance
There were **`r count(dist_del)` reports** of general disturbance or predator presence.

```{r map_dist_del}
dist_del %>% filter_2017 %>% group_by(disturbance_cause) %>% tally %>% arrange(-n) %>% kable
dist_del %>% map_dist
```



# Rosemary Nesting

## Maps
```{r map_ros}
tracks_ros %>% filter_2017() %>% map_tracks()
```


### Animated map
A [Google API key](https://developers.google.com/maps/documentation/geocoding/start?csw=1) must
be present as R environment variable `GOOGLE_MAPS_APIKEY` for the next step.

```{r map_ros_animated, warning=FALSE}
tracks_ros_2017 <- tracks_ros %>% filter_2017()
gganimate_tracks(tracks_ros_2017, placename_ros, prefix_ros)
```

### Tagged nests
The map is saved as a PNG file `r glue::glue(prefix_ros, "_tagged_nests.png")`.

Coming 2018.

```{r nests_ros, eval=F}
nests_ros %>% 
  filter_2017() %>%
  map_nests() %>%
  mapview::mapshot(file = glue::glue("{prefix}_tagged_nests_2017.png"))
```

## Nesting abundance
### All beaches
```{r tracks_all_sectors_ros}
tracks_ros %>% nesting_type_by_season_species() %>% kable()
```

## Nesting by week
### All beaches
The next table show data from all sites.

```{r tracks_all_beaches_by_week_ros}
tracks_ros %>% nesting_type_by_season_week_species() %>% kable()
```

## Nesting by day
This section shows data from all sites.

```{r nesting_success_ros, warning = F}
tracks_ros %>% tracks_ts(placename_ros, prefix_ros)
nests <- tracks_ros %>% track_success()
nests %>% ggplot_track_success_by_date("natator-depressus", placename_ros, prefix_ros)
nests %>% ggplot_track_successrate_by_date("natator-depressus", placename_ros, prefix_ros)
nests %>% ggplot_track_success_by_date("chelonia-mydas", placename_ros, prefix_ros)
nests %>% ggplot_track_successrate_by_date("chelonia-mydas", placename_ros, prefix_ros)
nests %>% track_success_by_species() %>% DT::datatable(.,
  caption = "Nesting success of fresh tracks (excl. nests without tracks and tagging)"
)
```

## Hatching and emergence success
```{r hatching_emergence_success_ros}
tracks_ros %>%
  hatching_emergence_success() %>%
  DT::datatable(., caption = "Hatching and emergence success summary", options = list(paging = F))
```

## Disturbance and predation
Disturbed nests are captured through form "Track or Treat" and appear here
as "tracks" with "disturbance" recorded as "present".

General signs of disturbance or predator presence are recorded through form 
"Fox Sake" and appear here as "dist_(place)".

### Disturbance and predation of nests
Turtle nests with recorded disturbance or predation.

```{r dist_nests_ros}
disturbed_nests_ros <- tracks_ros %>% filter_2017() %>% filter(disturbance == "present")
disturbed_nests_ros %>% map_tracks()
```

There were **`r count(disturbed_nests_ros)` reports** of disturbed nests. 
Caveat: QA to exclude possible training records.

Coming soon: details of disturbance to nests.

### General disturbance
There were **`r count(dist_ros)` reports** of general disturbance or predator presence.

```{r map_dist_ros}
dist_ros %>% filter_2017 %>% group_by(disturbance_cause) %>% tally %>% arrange(-n) %>% kable
dist_ros %>% map_dist
```




# Surveys
Curators are to QA 
[all `r placename_thv` surveys on WAStD](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__in=20,28,29),
[all `r placename_del` surveys on WAStD](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=39),
[all `r placename_ros` surveys on WAStD](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=40)
following the 
[QA instructions for surveys](https://wastd.readthedocs.io/data_curators.html#data-flow-of-surveys).

Split up per site:

* [Thevenard Island North Beach](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=28)
* [Thevenard Island South Beach](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=29)
* [Thevenard Island Tagging Area](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=20)
* [Delambre Island](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=39)
* [Rosemary Island](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__exact=40)



## Survey count

### Caveat
* Surveys with missing end points are auto-closed after 6 hours. 
* Data includes training surveys.

Both factors contribute to over-estimation of effort.

```{r survey_count}
surveys_thv %>% survey_count_heatmap(placename_thv, prefix_thv)
surveys_thv %>% list_survey_count(placename_thv)
surveys_thv %>% survey_hours_heatmap(placename_thv, prefix_thv)
surveys_thv %>% list_survey_effort(placename_thv)

surveys_del %>% survey_count_heatmap(placename_del, prefix_del)
surveys_del %>% list_survey_count(placename_del)
surveys_del %>% survey_hours_heatmap(placename_del, prefix_del)
surveys_del %>% list_survey_effort(placename_del)

surveys_ros %>% survey_count_heatmap(placename_ros, prefix_ros)
surveys_ros %>% list_survey_count(placename_ros)
surveys_ros %>% survey_hours_heatmap(placename_ros, prefix_ros)
surveys_ros %>% list_survey_effort(placename_ros)
```

## Survey effort per primary reporter
Q Which volunteer did the most hours overall on survey?

### Caveat
This list only includes the primary reporter. 
This leads to under-reporting of time spent by other volunteers attending the survey.
Their names are listed in the Site Visit Start form field "comments" as free text.
To correctly report on team member effort, curators have to read the list of 
team members in the Site Visit "comments" field and attach the correct users 
to the Survey team list.
Once the surveys are comprehensively attributed to all volunteers present, this
workbook has to be updated to include the Survey team's effort.

If the primary reporter forgot to update the username in the tablet,
their survey effort on that day is incorrectly attributed to the previous reporter.
The only way to reconcile attribution is to manually compare survey usernames with
team rosters.

```{r survey_effort_by_person}
personal_effort_thv <- surveys_thv %>% survey_hours_per_person()
personal_effort_thv %>% kable()

personal_effort_del <- surveys_del %>% survey_hours_per_person()
personal_effort_del %>% kable()

personal_effort_ros <- surveys_ros %>% survey_hours_per_person()
personal_effort_ros %>% kable()
```

## Survey effort in kilometers walked
Number of surveys per sector times length of site.

At Thevenard North Beach, assuming the trip was 6 km,
`r survey_ground_covered(surveys, 28, 6, season=2017)` km were walked 
in `r survey_count(surveys, 28, season=2017)` surveys.

At Thevenard South Beach, assuming the trip was 6 km,
`r survey_ground_covered(surveys, 29, 6, season=2017)` km were walked 
in `r survey_count(surveys, 29, season=2017)` surveys.

At Thevenard Nesting Beach, assuming the trip was 1 km,
`r survey_ground_covered(surveys, 20, 1, season=2017)` km were walked 
in `r survey_count(surveys, 20, season=2017)` surveys.

At Delambre, assuming the trip was 4 km,
`r survey_ground_covered(surveys, 39, 4, season=2017)` km were walked 
in `r survey_count(surveys, 39, season=2017)` surveys.

At Rosemary, assuming the trip was 4 km,
`r survey_ground_covered(surveys, 40, 4, season=2017)` km were walked 
in `r survey_count(surveys, 40, season=2017)` surveys.


# Data upload
## Raw data
* Raw data are exported into CSV spreadsheets.
* Key figures are exported into .png raster files.
* This report is rendered into a single HTML page.

```{r data_export_csv}
tracks_thv %>% select(-obs, -photos) %>% 
  readr::write_csv(glue::glue("{prefix_thv}_tracks.csv"))
surveys_thv %>% readr::write_csv(glue::glue("{prefix_thv}_surveys.csv"))
dist_thv %>% select(-photos) %>% 
  readr::write_csv(glue::glue("{prefix_thv}_disturbance.csv"))

tracks_del %>% select(-obs, -photos) %>% 
  readr::write_csv(glue::glue("{prefix_del}_tracks.csv"))
surveys_del %>% readr::write_csv(glue::glue("{prefix_del}_surveys.csv"))
dist_del %>% select(-photos) %>% 
  readr::write_csv(glue::glue("{prefix_del}_disturbance.csv"))

tracks_ros %>% select(-obs, -photos) %>% 
  readr::write_csv(glue::glue("{prefix_ros}_tracks.csv"))
surveys_ros %>% readr::write_csv(glue::glue("{prefix_ros}_surveys.csv"))
dist_ros %>% select(-photos) %>% 
  readr::write_csv(glue::glue("{prefix_ros}_disturbance.csv"))
```

## Data catalogue
Data are uploaded to the [turtle nest census dataset](https://data.dpaw.wa.gov.au/dataset/turtle-tracks) 
on the departmental data catalogue, accessible from the DBCA intranet only.

```{r data_upload}
# Package all output files into one ZIP archive
products_fn_thv <- glue::glue("{prefix_thv}_products.zip")
products_fn_del <- glue::glue("{prefix_del}_products.zip")
products_fn_ros <- glue::glue("{prefix_ros}_products.zip")

if (file.exists(products_fn_thv)) file.remove(products_fn_thv)
if (file.exists(products_fn_del)) file.remove(products_fn_del)
if (file.exists(products_fn_ros)) file.remove(products_fn_ros)

zip(zipfile = products_fn_thv, files = list.files(pattern=prefix_thv))
zip(zipfile = products_fn_del, files = list.files(pattern=prefix_del))
zip(zipfile = products_fn_ros, files = list.files(pattern=prefix_ros))

# Create a resource for the ZIP archives
# d <- ckanr::package_show("turtle-tracks")
# r <- resource_create(package_id=d$id, name="Thevenard outputs", upload=products_fn_thv)
# r <- resource_create(package_id=d$id, name="Delambre outputs", upload=products_fn_del)
# r <- resource_create(package_id=d$id, name="Rosemary outputs", upload=products_fn_ros)

# Update resources on data catalogue 
ckanr::resource_update("19294b29-a70f-45e3-b06b-fc1eefe858d2", "rose_del_thv_2017-18.html")
ckanr::resource_update("25c887fa-0561-495a-944a-734b01050e8a", products_fn_thv)
ckanr::resource_update("fd1c15a4-4766-4039-b3a7-5a3dd7b403a2", products_fn_del)
ckanr::resource_update("793e4584-a211-4372-ace2-31f81a0726c6", products_fn_ros)
```
