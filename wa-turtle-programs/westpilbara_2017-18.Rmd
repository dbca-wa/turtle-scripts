---
title: "West Pilbara Season Review 2017-2018"
author: "West Pilbara Turtle Program with Marine Turtles WA"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    fig_width: 9
    fig_height: 5
---

```{r r setup, include=FALSE, message=FALSE, warning=FALSE}
source("tracks_setup.R")
source("tracks_helpers.R")
```

# Caveat
The data shown are pending QA and reconciliation with paper-based records. 
Until this warning disappears, this dataset may contain duplicates from training runs, effort attributed to the wrong operators, and possibly other issues and biases.

# Data
```{r, eval=T}
source("load_data.R")
tracks_wp <- tracks_all %>% filter_wp() %>% filter_2017()
# tracks_cw <- tracks_all %>% filter_cw %>% filter_2017
tracks_bb <- tracks_all %>% filter_bb() %>% filter_2017()
tracks_yc <- tracks_all %>% filter_yc() %>% filter_2017()

surveys_wp <- surveys %>% filter_wp() %>% filter_2017()
# surveys_cw <- surveys %>% filter_cw %>% filter_2017
surveys_bb <- surveys %>% filter_bb() %>% filter_2017()
surveys_yc <- surveys %>% filter_yc() %>% filter_2017()

dist_wp <- disturbance %>% filter_wp() %>% filter_2017()
```

Note: Jason reported the following counts for manual entry (not done yet, so not showing up in this report):

```{r, eval=F}
# 16/11:
# 5 false crawls, 3 nests:
# -20.61127   117.15553 below dune
# -20.61067 117.15619 above high water
# -20.61138 117.15530 right on the high water mark
#  
# 22/11:
# 11 false crawls, 4 nests:
# -20.61144 117.15526 above high water
# -20.61031 117.15677 below dune
# -20.61119 117.15564 above high water
# -20.61129 117.15547 above high water
#  
# 23/11:
# 2 false crawls, 2 nests:
# -20.61149 117.15523 Above high water
# -20.61143 117.15528 Above high water
```

# Season summary

## General notes
Nests without a clearly visible emergence point were not recorded.
This led to under-reporting of hatched nests this season.

## Going digital
Entering and proofreading a record takes about 2 minutes with full concentration.
By going digital, data entry and proofreading are fully automated.
This season, the Volunteers have saved 
`r (nrow(tracks_wp) + nrow(surveys_wp)*2) * 2 / 60` hours of mind-numbing data entry
and proofreading work for `r nrow(tracks_wp)` Track or Treats and 
`r nrow(surveys_wp)*2` Site Visit Starts/Ends. 
This estimate excludes Fox Sakes and Marine Wildlife Incidents, about 2-3h extra!

## QA
### Tracks outside known sites
Actions: 

* Extend site polygons to include GPS error.
* Add sites for new surveyed beaches and create new report.
* Add sites for known training areas.
* Change training records outside training areas to "Hatchback turtles" and mark as "curated" to
  prevent from being overwritten by repeated data loading.
* Note: re-run uncached data import after changing tracks.

```{r missing_sites}
tracks_all %>% 
  filter(is.na(site_id)) %>%
  add_nest_labels() %>% 
  map_tracks()
```

### Tracks at known sites with missing surveys
Actions:

* Filter datatable to site of interest.
* Create missing surveys. This might be automatable.
* NNote: re-run uncached data import after adding surveys.

```{r missing_surveys}
tracks_all %>%
  filter_2017 %>%
  filter(is.na(survey_id)) %>%
  dplyr::group_by(date, site_name) %>%
  tally() %>%
  dplyr::arrange(site_name) %>%
  DT::datatable(.)
```


## Maps
```{r map_overall}
tracks_wp %>% add_nest_labels() %>% map_tracks()
tracks_bb %>% add_nest_labels() %>% map_tracks()
tracks_yc %>% add_nest_labels() %>% map_tracks()
```

## Nesting abundance
```{r tracks_all_sectors}
tracks_wp %>% species_by_type() %>% kable()
```

```{r tracks_bb}
# tracks_bb %>% species_by_type() %>% kable()
```

```{r tracks_yc}
# tracks_yc %>% species_by_type() %>% kable()
```

## Nesting success 
```{r nesting_success, fig.height=5, fig.width=7, warning = F}
label <- "wp"
tracks_wp %>% tracks_ts(placename = label)
nests <- tracks_wp %>% track_success()
nests %>% ggplot_track_success_by_date("natator-depressus", label)
# nests %>% ggplot_track_success_by_date("chelonia-mydas", label)
nests %>% ggplot_track_successrate_by_date("natator-depressus", label)
# nests %>% ggplot_track_successrate_by_date("chelonia-mydas", label)
nests %>% track_success_by_species() %>% datatable(.,
  caption = "Nesting success of fresh tracks (excl. nests without tracks and tagging)"
)
```

## Hatching and emergence success
```{r hatching_emergence_success}
tracks_wp %>%
  hatching_emergence_success() %>%
  DT::datatable(.,
    caption = "Hatching and emergence success summary",
    options = list(paging = F)
  )
```

## Disturbance and predation
Disturbed nests are captured through form "Track or Treat" and appear here
as "tracks" with "disturbance" recorded as "present".

General signs of disturbance or predator presence are recorded through form 
"Fox Sake" and appear here as "dist_(place)".

### Disturbance and predation of nests
Turtle nests with recorded disturbance or predation.

```{r}
disturbed_nests_wp <- tracks_wp %>% filter(disturbance == "present")
disturbed_nests_wp %>% add_nest_labels() %>% map_tracks()
```

There were **`r count(disturbed_nests_wp)` reports** of disturbed nests. Caveat: QA to exclude possible training records.

Coming soon: details of disturbance to nests.

### General disturbance
There were **`r count(dist_wp)` reports** of general disturbance or predator presence:

```{r}
dist_wp %>% group_by(disturbance_cause) %>% tally %>% arrange(-n) %>% kable
dist_wp %>% map_dist
```


## Survey count
Curators are to QA [all West Pilbara surveys on WAStD](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__in=25,26,27) following the 
[QA instructions for surveys](https://wastd.readthedocs.io/data_curators.html#data-flow-of-surveys).

### Caveat
* Data includes training surveys. (Not production, but also effort)

```{r survey_count}
place <- "West Pilbara"
surveys_wp %>% plot_survey_count(place)
surveys_wp %>% list_survey_count(place)

place <- "West Pilbara Bells Beach"
surveys_bb %>% plot_survey_count(place)
surveys_bb %>% list_survey_count(place)

place <- "West Pilbara Yacht Club Beach"
surveys_yc %>% plot_survey_count(place)
surveys_yc %>% list_survey_count(place)
```

## Survey effort in hours
Q How many hours did volunteers survey, how many kilometers were walked?

### Caveat
* Surveys with missing end points are auto-closed after 5 hours (over-estimation of effort).
* Data includes training surveys.
* Data excludes commute to survey site.

```{r survey_effort}
surveys_wp %>% plot_survey_effort("West Pilbara")
surveys_wp %>% list_survey_effort("West Pilbara")

surveys_bb %>% plot_survey_effort("West Pilbara Bells Beach")
surveys_bb %>% list_survey_effort("West Pilbara Bells Beach")

surveys_yc %>% plot_survey_effort("West Pilbara Yacht Club Beach")
surveys_yc %>% list_survey_effort("West Pilbara Yacht Club Beach")
```

## Survey effort per primary reporter
Q Which volunteer did the most hours overall on survey?

### Caveat
This list only includes the primary reporter. 
This leads to under-reporting of time spent by other volunteers attending the survey.
Their names are listed in the Site Visit Start form field "comments" as free text, and from 2018, in the Site Visit Start form field "team".
To correctly report on team member effort, curators have to read the list of 
team members in the Site Visit "comments" field and attach the correct users 
to the Survey team list. From 2018, this will be automated but still requires QA.
Once the surveys are comprehensively attributed to all volunteers present, the code underneath this
workbook has to be updated to include the Survey team's effort.

If the primary reporter forgot to update the username in the tablet,
their survey effort on that day is incorrectly attributed to the previous reporter.
The only way to reconcile attribution is to manually compare survey usernames with team rosters.

```{r survey_effort_by_person}
personal_effort <- surveys_wp %>% survey_hours_per_person()
personal_effort %>% kable()
```

## Survey effort in kilometers walked
Number of surveys per sector times length of site.
This includes local knowledge about distances on site.

At Bells Beach, assuming the round trip was 2 km,
`r survey_ground_covered(surveys, 25, 2)` km were walked 
in `r survey_count(surveys_wp, 25)` surveys.

At Yacht Club Beach, assuming the round trip was 1 km,
`r survey_ground_covered(surveys, 27, 1)` km were walked 
in `r survey_count(surveys_wp, 27)` surveys.

# Data upload

```{r data_upload}
# d <- ckanr::package_show("turtle-tracks")
ckanr::resource_update("1c57e04a-c29c-464c-b82d-a69e4ee0b199", "westpilbara_2017-18.html")
```

```{r data_export}
tracks_wp %>% select(-obs, -photos) %>% readr::write_csv("../data/tracks_wp.csv")
surveys_wp %>% readr::write_csv("../data/surveys_wp.csv")
dist_wp %>% select(-photos) %>% readr::write_csv("../data/dist_wp.csv")
```

