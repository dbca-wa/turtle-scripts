---
title: "Care for Hedland Season Review 2017-2018"
author: "Care for Hedland with Marine Turtles WA"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    fig_width: 9
    fig_height: 5
---

```{r r setup, include=FALSE, message=FALSE, warning=FALSE}
source("tracks_setup.R")
source("tracks_helpers.R")
```

# Data
```{r, eval=T}
source("load_data.R")
tracks_2017 <- tracks_all %>% filter_2017()
tracks_pth <- tracks_2017 %>% filter_port_hedland_sites()
tracks_pth_cem <- tracks_2017 %>% filter_port_hedland_cemetery()
tracks_pth_ppo <- tracks_2017 %>% filter_port_hedland_prettypool()
surveys_pth <- surveys %>% filter_port_hedland_sites() %>% filter_2017()
dist_pth <- disturbance %>% filter_port_hedland_sites() %>% filter_2017()

prefix <- "CFH"
placename <- "Port Hedland"
```

# QA
This section identifies tracks and disturbances outside known sites, missing surveys, and surveys requiring editing.
We show data from all regions as not to miss any stray records - ignore data not relevant to this analysis.

## Tracks outside known sites
* If tracks are close to sites: Extend WAStD site polygons to include GPS error.
* Add WAStD sites for new surveyed sites (production or training) and include those sites in existing or new report.
* Change confirmed training records outside training areas to "Hatchback turtles" and mark as "curated" to
  prevent from being overwritten by repeated data loading.
* Note: re-run uncached data import after changing tracks.

```{r tracks_missing_sites}
tracks_all %>% 
  filter_nosite() %>%
  add_nest_labels() %>% 
  map_tracks()
```

```{r dist_missing_sites}
disturbance %>% filter_nosite() %>% map_dist()
```

## Tracks at known sites with missing surveys
Actions:

* Filter datatable to site of interest by typing the site name into the "Search" box.
* Create missing surveys, one for each row in the table. (This will be automated early 2019.)
* Re-run uncached data import after adding surveys, as data for surveys, 
  tracks and disturbance will change.
  
TODO: find earliest observation and reporter on given dates. (group by > summarize)

```{r missing_surveys}
tracks_all %>%
  filter_2017 %>%
  filter_nosurvey() %>%
  dplyr::group_by(site_name, date) %>%
  dplyr::summarise(earliest_record = min(datetime), 
                   latest_record = max(datetime), 
                   reporter = first(reporter),
                   no_tracks = n()) %>%
  DT::datatable(.)
```

### QA: Surveys
Curators are to QA [all Pt Hedland surveys on WAStD](https://tsc.dbca.wa.gov.au/admin/observations/survey/?site__id__in=35,45) following the 
[QA instructions for surveys](https://wastd.readthedocs.io/data_curators.html#data-flow-of-surveys).

### QA: Surveys missing Site Visit End
Where a "Site visit end" was forgotten, "end source id" is empty, and the duration is set to 6h. 
These surveys should be closed a few minutes after the last recorded track or disturbance.

Surveys with missing end contribute to an over-estimation of survey effort.

TODO: list datetime of last record.
  
```{r}
surveys_pth %>% 
  dplyr::filter(is.na(end_source_id)) %>%
  dplyr::select(-site_type, -site_id, -reporter_username, -reporter_id, -id, -absolute_admin_url) %>% 
  DT::datatable(escape = FALSE, rownames = FALSE)
```

### QA: Provided username mismatches WAStD users
TODO: define QA rules for mismatches of usernames as (possibly mis)typed by data collectors vs 
[WAStD users](https://tsc.dbca.wa.gov.au/admin/users/user/).
```{r}
surveys_pth %>% 
  dplyr::filter(grepl("QA", start_comments) | grepl("QA", end_comments)) %>%
  dplyr::select(site_name, reporter, date, start_time, end_time, start_comments, end_comments, change_url) %>% 
  DT::datatable(escape = FALSE, rownames = FALSE)
```

# Season summary

## General notes
Nests without a clearly visible emergence point were not recorded.
This led to under-reporting of hatched nests this season.

## Going digital
Entering and proofreading a record takes about 2 minutes with full concentration.
By going digital, data entry and proofreading are fully automated.
This season, the Care for Hedland Volunteers have saved Jo and the Kellies 
`r (nrow(tracks_pth) + nrow(surveys_pth)*2) * 2 / 60` hours of mind-numbing data entry
and proofreading work for `r nrow(tracks_pth)` Track or Treats and 
`r nrow(surveys_pth)*2` Site Visit Starts/Ends. 
This estimate excludes Fox Sakes and Marine Wildlife Incidents, about 2-3h extra!

## Maps
```{r map_cem}
tracks_pth_cem %>% add_nest_labels() %>% map_tracks()
```

```{r map_ppo}
tracks_pth_ppo %>% add_nest_labels() %>% map_tracks()
```


## Nesting abundance
```{r tracks_all_sectors}
tracks_pth %>% species_by_type() %>% kable()
```

## Cemetery Beach
```{r tracks_cem}
tracks_pth_cem %>% species_by_type() %>% kable()
```

## Pretty Pool Beach
```{r tracks_ppo}
tracks_pth_ppo %>% species_by_type() %>% kable()
```

## Nesting success 
```{r nesting_success, fig.height=5, fig.width=7, warning = F}
label <- "pth"
tracks_pth %>% tracks_ts(placename, prefix)
tracks_pth_cem %>% tracks_ts("Cemetery Beach", prefix)
tracks_pth_ppo %>% tracks_ts("Pretty Pool Beach", prefix)

nests <- tracks_pth %>% track_success()

nests %>% ggplot_track_success_by_date("natator-depressus", placename, prefix)
nests %>% ggplot_track_successrate_by_date("natator-depressus", placename, prefix)
nests %>% track_success_by_species() %>% datatable(.,
  caption = "Nesting success of fresh tracks (excl. nests without tracks and tagging)"
)
```

## Hatching and emergence success
```{r hatching_emergence_success}
tracks_pth %>%
  hatching_emergence_success() %>%
  DT::datatable(.,
    caption = "Hatching and emergence success summary",
    options = list(paging = F)
  )
```

## Disturbance and predation
Disturbed nests are captured through form "Track or Treat" and appear here
as "tracks" with "disturbance" recorded as "present".

General signs of disturbance or predator presence are recorded through form 
"Fox Sake" and appear here as "dist_(place)".

### Disturbance and predation of nests
Turtle nests with recorded disturbance or predation.

```{r}
disturbed_nests_pth <- tracks_pth %>% filter(disturbance == "present")
disturbed_nests_pth %>% add_nest_labels() %>% map_tracks()
```

There were **`r count(disturbed_nests_pth)` reports** of disturbed nests. Caveat: QA to exclude possible training records.

Coming soon: details of disturbance to nests.

### General disturbance
Coming soon: map.

There were **`r count(dist_pth)` reports** of general disturbance or predator presence:

```{r}
dist_pth %>% group_by(disturbance_cause) %>% tally %>% arrange(-n) %>% kable
dist_pth %>% map_dist
```

## Survey count

### Caveat
* Data includes training surveys. This contributes to over-estimation of effort, but shows actual boots on the 
  ground - training is also an effort!

TODO: include column "is_production" in overview.

Note: date shown is "turtle date" (calendar date minus one day).

Actions:

* Dates with multiple production surveys on the same site: 
  * Decide on one survey to be the production survey.
  * Transcribe reporters of other surveys to the chosen production survey and mark other surveys as 
    "not production" = training surveys. 
  * Save all surveys and mark as "proofread".

```{r}
surveys_pth %>% plot_survey_count(placename, prefix)
surveys_pth %>% list_survey_count(placename)
```

## Survey effort in hours
### Caveat
* Surveys with missing end points are auto-closed after 5 hours. 
* Data includes training surveys.

Both factors contribute to over-estimation of effort.

```{r survey_effort}
surveys_pth %>% plot_survey_effort(placename, prefix)
surveys_pth %>% list_survey_effort(placename)
```

## Survey effort per person
Q Which volunteer did the most hours overall on survey?

### Caveat
This list only includes the primary reporter. This leads to under-reporting, as time spent
as team is not reported on.

```{r survey_effort_by_person}
personal_effort <- surveys_pth %>% survey_hours_per_person()
personal_effort %>% kable()
```

## Survey effort in kilometers walked
Number of surveys per sector times length of site.

At Cemetery Beach, `r survey_ground_covered(surveys, 35, 1.6)` km were walked 
in `r survey_count(surveys_pth, 35)` surveys.

At Pretty Pool Beach, `r survey_ground_covered(surveys, 45, 1.8)` km were walked 
in `r survey_count(surveys_pth, 45)` surveys.

# Data upload
### Data catalogue
```{r data_upload}
# Package all output files into one ZIP archive
products <- list.files(pattern=prefix)
products_fn <- glue::glue("{prefix}_products.zip")
zip(zipfile = products_fn, files = products)

# Create a resource for the ZIP archive
# d <- ckanr::package_show("turtle-tracks")
# r <- resource_create(package_id=d$id, name="Care for Hedland figures", upload=products_fn)

# Update resources on data catalogue 
ckanr::resource_update("b35fb19e-e72d-420c-b875-12b4db4afe8c", "pthedland_2017-18.html")
ckanr::resource_update("d8c309c4-66c2-449f-bdb3-5f41d3f15315", products_fn)
```

### Google Drive
You'll need a file `.httr-oauth` with authentication credentials as generated by `googledrive::drive_auth()`.
This chunk doesn't seem to work from RStudio Server, as Google oauth opens a localhost browser tab.

```{r google_drive, eval=F}
googledrive::drive_ls("CfH") %>% googledrive::drive_rm(.)
googledrive::drive_upload("pthedland_2017-18.html", path="CfH/pthedland_2017-18.html")
products %>% purrr::map(drive_upload, path=as_dribble("CfH"))
```
