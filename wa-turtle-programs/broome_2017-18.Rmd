---
title: "Broome season review 2017-18"
author: "Marine Turtles WA"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    fig_width: 9
    fig_height: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(wastdr)
library(dplyr)
library(tidyr)
library(magrittr)
library(skimr)
library(leaflet)
library(lubridate)
library(listviewer)
library(DT)
library(ggplot2)
```

# Data

## Load data
```{r get_data}
if (file.exists("../data/tracks.Rda")){
    load("../data/tracks.Rda")
} else {
    track_records <- wastdr::get_wastd("turtle-nest-encounters")
    tracks <- parse_turtle_nest_encounters(track_records)
    save(tracks, track_records, file = "../data/tracks.Rda")
}
```

## Helpers
```{r helpers}
species_colours <- tibble::tibble(
    species = c(
    "cheloniidae-fam",
    "chelonia-mydas",
    "eretmochelys-imbricata",
    "natator-depressus",
    "corolla-corolla",
    "lepidochelys-olivacea",
    "caretta-caretta"    
    ),
    species_colours = c(
    "gray",
    "green",
    "darkblue",
    "beige",
    "pink",
    "darkgreen",
    "orange"
    )
)

nest_type_text <- tibble::tibble(
    nest_type = c(
        "hatched-nest", 
        "successful-crawl",
        "track-not-assessed",
        "track-unsure",
        "nest",
        "false-crawl"),
    nest_type_text = c(
        "NH", 
        "N",
        "T+?",
        "N?",
        "N",
        "T")
)


add_lookups <- . %>% 
    left_join(species_colours, by="species") %>%
    left_join(nest_type_text, by="nest_type")

filter_2017 <- . %>% dplyr::filter(date > dmy("17/10/2017")) %>% add_lookups
filter_broome <- . %>% dplyr::filter(area_name=="Cable Beach Broome")
filter_cbb1 <- . %>% dplyr::filter(site_name=="Cable Beach Broome Sector 1")
filter_cbb2 <- . %>% dplyr::filter(site_name=="Cable Beach Broome Sector 2")
filter_cbb3 <- . %>% dplyr::filter(site_name=="Cable Beach Broome Sector 3")

tracks_map <- function(track_data) {
    l <- leaflet(width=800, height=600) %>% 
        addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
        addProviderTiles("OpenStreetMap.Mapnik", group = "Place names") %>%
        clearBounds()

    tracks.df <-  track_data %>% split(track_data$species)
    
    names(tracks.df) %>%
        purrr::walk( function(df) {
            l <<- l %>%
                addAwesomeMarkers(
                    data = tracks.df[[df]],
                    lng = ~longitude, lat=~latitude,
                    icon = leaflet::makeAwesomeIcon(
                        text = ~nest_type_text,
                        markerColor = ~species_colours),
                    label=~paste(date, nest_age, species, nest_type, name),
                    popup=~paste(date, nest_age, species, nest_type, name),
                    group = df
                )
        })
    
    l %>%
        addLayersControl(
            baseGroups = c("Aerial", "Place names"),
            overlayGroups = names(tracks.df),
            options = layersControlOptions(collapsed = FALSE)
        )
}

daily_species_by_type <- . %>% 
    filter(nest_age=="fresh") %>%
    group_by(date, species, nest_type) %>% 
    tally() %>%
    ungroup()

daily_summary <- . %>% 
    daily_species_by_type %>% 
    tidyr::spread(nest_type, n, fill=0) %>%
    DT::datatable(.)

species_by_type <- . %>% 
  filter(nest_age=="fresh") %>%
  group_by(species, nest_type) %>% 
  tally() %>%
  ungroup() %>% 
  tidyr::spread(nest_type, n, fill=0)

tracks_ts <- . %>% 
    daily_species_by_type %>% 
    {ggplot2::ggplot(data=., aes(x = date, y = n, colour = nest_type)) + 
            ggplot2::geom_point() + 
            ggplot2::geom_smooth(method = "auto") +
            # ggplot2::geom_line() +
            ggplot2::scale_x_date(breaks = scales::pretty_breaks(),
                                  labels = scales::date_format("%d %b %Y")) +
            ggplot2::scale_y_continuous(limits = c(0, NA)) +
            ggplot2::xlab("Date") +
            ggplot2::ylab("Number counted per day") +
            ggplot2::ggtitle("Nesting activity") +
            ggplot2::theme_light()}
```

## Filter data

```{r, eval=T}
cbb <- tracks %>% filter_2017 %>% filter_broome
cbb1 <- tracks %>% filter_2017 %>% filter_cbb1
cbb2 <- tracks %>% filter_2017 %>% filter_cbb2
cbb3 <- tracks %>% filter_2017 %>% filter_cbb3
```

# Season summary

## Maps
```{r map_overall}
cbb %>% tracks_map
```
## How many nests did we have all together across all sectors?
```{r tracks_all_sectors}
cbb %>% species_by_type %>% kable
```
## How many nests were found in each sector?

## Sector 1
```{r tracks_sector_1}
cbb1 %>% species_by_type %>% kable
```

## Sector 2
```{r tracks_sector_2}
cbb2 %>% species_by_type %>% kable
```

## Sector 3
```{r tracks_sector_3}
cbb3 %>% species_by_type %>% kable
```

## How many false crawls were recorded total and each sector?
```{r nesting_success}
cbb %>% tracks_ts
cbb1 %>% tracks_ts
cbb2 %>% tracks_ts
cbb3 %>% tracks_ts
```


## How many nests were hatched?
## How many nests were predated?
## What types of predation were recorded?
## How many hatchlings were stuck in sand or dead the next morning?
## How many days of surveys across all sectors did we have out of 120 days monitoring period
## How many hours volunteers provided = number  of kmâ€™s walked?
## Which volunteer did the most hours overall on survey?
