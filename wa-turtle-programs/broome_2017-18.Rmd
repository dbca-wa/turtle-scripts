---
title: "Broome season review 2017-18"
author: "Marine Turtles WA, Sarah Mullineux, Florian Mayer"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    fig_width: 9
    fig_height: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(wastdr)
library(dplyr)
library(tidyr)
library(magrittr)
library(skimr)
library(leaflet)
library(lubridate)
library(listviewer)
library(DT)
library(ggplot2)
```

# Data

## Load data
```{r get_data}
if (file.exists("../data/tracks.Rda")){
    load("../data/tracks.Rda")
} else {
    track_records <- wastdr::wastd_GET("turtle-nest-encounters")
    tracks_all <- parse_turtle_nest_encounters(track_records)
    surveys <- wastd_GET("surveys") %>% parse_surveys()
    save(tracks_all, track_records, surveys, file = "../data/tracks.Rda")
}
```

## Helpers
```{r helpers}
filter_2017 <- . %>% dplyr::filter(date > dmy("17/10/2017"))
filter_broome <- . %>% dplyr::filter(area_name=="Cable Beach Broome")
filter_cbb1 <- . %>% dplyr::filter(site_name=="Cable Beach Broome Sector 1")
filter_cbb2 <- . %>% dplyr::filter(site_name=="Cable Beach Broome Sector 2")
filter_cbb3 <- . %>% dplyr::filter(site_name=="Cable Beach Broome Sector 3")
filter_broome_sites <- . %>% dplyr::filter(site_id %in% c(22, 23, 24))

daily_species_by_type <- . %>% 
    filter(nest_age=="fresh") %>%
    group_by(date, species, nest_type) %>% 
    tally() %>%
    ungroup()

daily_summary <- . %>% 
    daily_species_by_type %>% 
    tidyr::spread(nest_type, n, fill=0) %>%
    DT::datatable(.)

species_by_type <- . %>% 
  filter(nest_age=="fresh") %>%
  group_by(species, nest_type) %>% 
  tally() %>%
  ungroup() %>% 
  tidyr::spread(nest_type, n, fill=0)

tracks_ts <- . %>% 
    daily_species_by_type %>% 
    {ggplot2::ggplot(data=., aes(x = date, y = n, colour = nest_type)) + 
            ggplot2::geom_point() + 
            ggplot2::geom_smooth(method = "auto") +
            # ggplot2::geom_line() +
            ggplot2::scale_x_date(breaks = scales::pretty_breaks(),
                                  labels = scales::date_format("%d %b %Y")) +
            ggplot2::scale_y_continuous(limits = c(0, NA)) +
            ggplot2::xlab("Date") +
            ggplot2::ylab("Number counted per day") +
            ggplot2::ggtitle("Nesting activity") +
            ggplot2::theme_light()}
```

## Filter data

```{r, eval=T}
cbb <- tracks_all %>% filter_2017 %>% filter_broome
cbb1 <- tracks_all %>% filter_2017 %>% filter_cbb1
cbb2 <- tracks_all %>% filter_2017 %>% filter_cbb2
cbb3 <- tracks_all %>% filter_2017 %>% filter_cbb3
```

# Season summary

## Maps
```{r map_overall}
cbb %>% add_nest_labels %>% map_tracks
```
## How many nests did we have all together across all sectors?
```{r tracks_all_sectors}
cbb %>% species_by_type %>% kable
```
## How many nests were found in each sector?

## Sector 1
```{r tracks_sector_1}
cbb1 %>% species_by_type %>% kable
```

## Sector 2
```{r tracks_sector_2}
cbb2 %>% species_by_type %>% kable
```

## Sector 3
```{r tracks_sector_3}
cbb3 %>% species_by_type %>% kable
```

## How many false crawls were recorded total and each sector?
```{r nesting_success}
cbb %>% tracks_ts
cbb1 %>% tracks_ts
cbb2 %>% tracks_ts
cbb3 %>% tracks_ts
```

## How many nests were hatched?
## How many nests were predated?
## What types of predation were recorded?
## How many hatchlings were stuck in sand or dead the next morning?

## Survey count
Q How many days of surveys across all sectors did we have out of 120 days monitoring period?

### Caveat
* Data includes training surveys.

This contributes to over-estimation of effort, but shows actual boots on the 
ground - training is also an effort!

```{r}
surveys_cbb <- surveys %>% filter_broome_sites
place <- "Cable Beach Broome"
surveys_cbb %>% plot_survey_count(place)
surveys_cbb %>% list_survey_count(place)
```

## Survey effort in hours
Q How many hours did volunteers survey, how many kilometers were walked?

### Caveat
* Surveys with missing end points are auto-closed after 5 hours. 
* Data includes training surveys.

Both factors contribute to over-estimation of effort.

```{r survey_effort}
surveys_cbb %>% plot_survey_effort(place)
surveys_cbb %>% list_survey_effort(place)
```

## Which volunteer did the most hours overall on survey?
```{r survey_effort_by_person}
surveys_cbb %>% survey_hours_per_person %>% DT::datatable(.)
```
